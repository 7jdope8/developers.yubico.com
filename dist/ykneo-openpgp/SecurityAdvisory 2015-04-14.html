<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>SecurityAdvisory 2015-04-14</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/ykneo-openpgp">ykneo-openpgp</a></li>
<li class="active">SecurityAdvisory 2015-04-14</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/ykneo-openpgp">ykneo-openpgp</a><ul class="">
<li><a href="/ykneo-openpgp/Release_Notes.html">Release Notes</a></li>
<li><a href="/ykneo-openpgp/Building.html">Building</a></li>
<li><a href="/ykneo-openpgp/InstallCAPFile.html">InstallCAPFile</a></li>
<li><a href="/ykneo-openpgp/PinRetries.html">PinRetries</a></li>
<li><a href="/ykneo-openpgp/ResetApplet.html">ResetApplet</a></li>
<li class="active"><a href="/ykneo-openpgp/SecurityAdvisory 2015-04-14.html">SecurityAdvisory 2015-04-14</a>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/ykneo-openpgp" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content"><h1>SecurityAdvisory 2015-04-14</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Tracking IDs: YSA-2015-1 and CVE-2015-3298.</p></div>
<div class="paragraph"><p><strong>Update; April, 27, 2015: Yubico will replace your YubiKey NEO if you are
using the OpenPGP applet version 1.0.9 or earlier (as described in this
advisory). Go to <a href="https://yubi.co/support">https://yubi.co/support</a> and provide the order number and
serial number of the YubiKey NEO device that you need replaced.</strong></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_background">Background</h2>
<div class="sectionbody">
<div class="paragraph"><p>The YubiKey NEO is a flexible security product from Yubico that
implements the Yubico One-Time Password technology, FIDO Universal 2nd
Factor, OATH codes, PIV card, and OpenPGP card functionality.  The
on-card OpenPGP software of the YubiKey NEO is implemented by the free
and open-source software (FOSS) project "ykneo-openpgp", forked from
an earlier implementation called “javacardopenpgp”.</p></div>
<div class="paragraph"><p>Links:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://www.yubico.com/">https://www.yubico.com/</a>
</p>
</li>
<li>
<p>
<a href="https://developers.yubico.com/ykneo-openpgp/">https://developers.yubico.com/ykneo-openpgp/</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/Yubico/ykneo-openpgp">https://github.com/Yubico/ykneo-openpgp</a>
</p>
</li>
<li>
<p>
<a href="http://sourceforge.net/projects/javacardopenpgp/">http://sourceforge.net/projects/javacardopenpgp/</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph"><p>The source code contains a logical flaw related to user
PIN (aka PW1) verification that allows an attacker with local host privileges
and/or physical proximity (NFC) to perform security operations without
knowledge of the user’s PIN code.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_mitigation">Mitigation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The flaw is mitigated by the fact that an attacker would typically
require some abilities that would enable the attack even without the
logical flaw.</p></div>
<div class="paragraph"><p>In particular, any attacker with access to the local host must be
assumed to be able to learn the user’s PIN code, simply by
intercepting communication with the OpenPGP card hardware or through
key logging.</p></div>
<div class="paragraph"><p>Alternatively, if the attacker has physical proximity to the card, it
could wait for the device to be used normally over NFC and then learn
the PIN code wirelessly and perform the attack at a later point.</p></div>
<div class="paragraph"><p>If your device is stolen, attackers may use it to perform private-key
operations.  If an attacker has gone through the trouble of obtaining
physical access to a key, the conservative approach is to regard it is
possible that the attacker were able to learn the PIN earlier since the
PIN is often unprotected.  In situations like this, you should treat the
key as potentially compromised and revoke the key.</p></div>
<div class="paragraph"><p>Generally the OpenPGP Card specification does not protect against
private key-usage by malware and/or PIN phishing, and any OpenPGP Card
implementation is vulnerable to similar attacks.</p></div>
<div class="paragraph"><p>Note that the private key is not at jeopardy, and malware cannot learn
the private key — this is in fact the primary threat that the
OpenPGP card specification protects against.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_analysis">Analysis</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following description is courtesy of Joey Castillo.</p></div>
<div class="paragraph"><p>The bug appears to be a typo in the first line of the
computeDigitalSignature, decipher and internalAuthenticate
methods. The goal of each is to establish that the PW1 has been
validated, AND the proper mode has been set (mode 81 for signing, mode
82 for everything else). According to the spec, if either of these
conditions are not satisfied, the security operation should not
proceed.</p></div>
<div class="paragraph"><p>The application mangles this a bit, as you can see in line 628:</p></div>
<div class="paragraph"><p><a href="https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L628">https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L628</a></p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>if (!pw1.isValidated() &amp;&amp; pw1_modes[PW1_MODE_NO81])
    ISOException.throwIt(SW_SECURITY_STATUS_NOT_SATISFIED);
// otherwise execution continues</pre>
</div></div>
<div class="paragraph"><p>This truth table shows the outcome of the conditional, and the two
cases where the logic fails:</p></div>
<table class="table table-bordered table-striped tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top">Case </th>
<th class="tableblock halign-left valign-top"> PIN valid </th>
<th class="tableblock halign-left valign-top"> Mode 81 </th>
<th class="tableblock halign-left valign-top"> !(PIN valid) </th>
<th class="tableblock halign-left valign-top"> Result </th>
<th class="tableblock halign-left valign-top"> Outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No exception</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception thrown</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No exception (Incorrect)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No exception (Incorrect)</p></td>
</tr>
</tbody>
</col></col></col></col></col></col></table>
<div class="paragraph"><p>I discovered this bug due to case #3: OpenKeychain for Android
mistakenly verifies the PIN with mode 82 for signing, which should not
allow a signature to be generated. The Yubikey generates a signature
anyway.</p></div>
<div class="paragraph"><p>The dire case is #4: when the card is powered up, the PIN has not been
validated, and both modes are set to false. In this state, the card
will issue a signature even though the PIN has not been validated. The
same bug is present in the decipher command (line 659) and the
internalAuthenticate command (line 683), just with the mode set to
82. This means the card will also decrypt session keys and
authenticate challenges unconditionally.</p></div>
<div class="paragraph"><p><a href="https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L659">https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L659</a></p></div>
<div class="paragraph"><p><a href="https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L683">https://github.com/Yubico/ykneo-openpgp/blob/f82f3e4dc80e4476e90411bc837c52d6e1c9355f/applet/src/openpgpcard/OpenPGPApplet.java#L683</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_solution">Solution</h2>
<div class="sectionbody">
<div class="paragraph"><p>This is also courtesy of Joey Castillo.</p></div>
<div class="paragraph"><p>The fix is to change each of the conditionals to the following:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>if (!pw1.isValidated() || !pw1_modes[PW1_MODE_NO8x])
    ISOException.throwIt(SW_SECURITY_STATUS_NOT_SATISFIED);
// otherwise execution continues</pre>
</div></div>
<div class="paragraph"><p>This way, if the PIN has not been validated, OR the proper mode has
not been set, an exception is thrown. Execution is only allowed to
continue if both conditions are true.</p></div>
<div class="paragraph"><p>This fix has been integrated into ykneo-openpgp and is part of the
version 1.0.9 release, but read on for some information about 1.0.10.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_check_if_you_are_affected">How to check if you are affected</h2>
<div class="sectionbody">
<div class="paragraph"><p>Versions below 1.0.9 are affected by this problem.  Unfortunately,
some YubiKey NEOs shipped with a 1.0.9 release that did not contain
the fix.  To simplify version checking, we have released 1.0.10 and
NEOs using that version is known to always include the fix.  To be
certain that your NEO has the fixed ykneo-openpgp applet installed,
look for a version of 1.0.10 or later.</p></div>
<div class="paragraph"><p>You may check the applet version with the following command.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre> $ gpg-connect-agent --hex "scd apdu 00 f1 00 00" /bye
 D[0000]  01 00 06 90 00                                     .....
 OK</pre>
</div></div>
<div class="paragraph"><p>The string "01 00 06" means version 1.0.6, which would be affected by
this problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_recommendation">Recommendation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The logical flaw is real and violates assumption of how the OpenPGP
applet works in principle.  However its practical consequences are
relatively small as a successful attack requires other privileged
operations (such as local root access) that are normally not available
to an attacker, and would have undermined the security anyway.</p></div>
<div class="paragraph"><p><strong>Regardless of this assessment, Yubico has decided to replace YubiKey NEO keys for those who are using the OpenPGP applet version 1.0.9 or earlier. This replacement program began on April 26, 2015. For information on how to log a support ticket and receive a replacement YubiKey, see <a href="https://yubi.co/support">yubi.co/support</a>.</strong></p></div>
<p>
<del>
Therefore, we don't see any immediate need for users to upgrade existing
deployed products.  We will incorporate the improved code in future
products sold, and add self-tests to our software project to detect any
regression in this area.
</del>
</p>
<div class="paragraph"><p>For stolen devices, we continue to recommend users to follow best-practices
and revoke the key as a conservative measure.</p></div>
<div class="paragraph"><p>As we take all security related incidents seriously we have prepared a
prompt security advisory and released all information about this
incident that we know about.  We welcome further analysis of the
source code, as this will over time increase confidence in the
product, and is the reason the source is available.</p></div>
<div class="paragraph"><p>If you have additional inquiries related to your YubiKey NEO purchase,
please contact your sales contact for further discussion.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_related_projects">Related projects</h2>
<div class="sectionbody">
<div class="paragraph"><p>This defect was present in the code we inherited from the “javacardopenpgp”
project, and that project has been notified.  There may be other forks, public
or not, and we recommend the community to review other code with the same
origin.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_history_of_events">History of events</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
2015-04-11 Reported by Joey Castillo.
</p>
</li>
<li>
<p>
2015-04-11 Version 1 of security advisory circulated for review.
</p>
</li>
<li>
<p>
2015-04-13 Mitre assigned id for vulnerability as CVE-2015-3298.
</p>
</li>
<li>
<p>
2015-04-13 Upstream project “javacardopenpgp” notified.
</p>
</li>
<li>
<p>
2015-04-14 Security advisory published.
</p>
</li>
<li>
<p>
2015-04-20 Some 1.0.9 NEOs were shipped without the fix, text updated
             to recommend looking for 1.0.10 as a better minimum version.
</p>
</li>
<li>
<p>
2015-04-27 Add an update about Yubico replacement policy.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>