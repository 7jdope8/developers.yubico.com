<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Certificate authority</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li class="active"><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/PIV">PIV</a></li>
<li><a href="/PIV/Guides">Guides</a></li>
<li class="active">Certificate authority</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/PIV">PIV</a><ul class="">
<li><a href="/PIV/Introduction">Introduction</a></li>
<li><a href="/PIV/Tools">Tools</a></li>
<li class="active"><a href="/PIV/Guides">Guides</a><ul class="">
<li><a href="/PIV/Guides/Device_setup.html">Device setup</a></li>
<li class="active"><a href="/PIV/Guides/Certificate_authority.html">Certificate authority</a>
<li><a href="/PIV/Guides/SSH_with_PIV_and_PKCS11.html">SSH with PIV and PKCS11</a></li>
<li><a href="/PIV/Guides/SSH_user_certificates.html">SSH user certificates</a></li>
<li><a href="/PIV/Guides/Windows_CA_issued_certificate.html">Windows CA issued certificate</a></li>
<li><a href="/PIV/Guides/Android_code_signing.html">Android code signing</a></li>
<li><a href="/PIV/Guides/Generating_keys_using_OpenSSL.html">Generating keys using OpenSSL</a></li>
<li><a href="/PIV/Guides/Mac_code_signing.html">Mac code signing</a></li>
</li></ul>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/developers.yubico.com/issues/new?title=Suggested%20edit%20for%20PIV/Guides/Certificate_authority" rel="noopener noreferrer" target="_blank"><i class="fa fa-pencil-square-o fa-lg"></i> Suggest Edits</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_certificate_authority_with_a_yubikey">Certificate Authority with a YubiKey</h1>
<div class="sectionbody">
<div class="paragraph"><p>This document explains how to set up a Certificate Authority (CA) with
Sub-CA private keys stored on YubiKeys.  Typical use for this is
to generate HTTPS certificates for internal servers.</p></div>
<div class="sect2">
<h3 id="_considerations">Considerations</h3>
<div class="paragraph"><p>For our example, we have chosen to use one root CA with a private key
stored in an offline machine, that signs sub-CAs with private keys
stored on YubiKeys, which signs end-entity (EE) certs.  Weâ€™ll
generate the Sub-CA private keys on an offline host and save a copy of
those keys.</p></div>
<div class="paragraph"><p>We have chosen to use a RSA 3744 bit root CA key, and RSA 2048 bit
keys for the Sub-CAs and EE certificates.  The YubiKey is limited to
RSA 1k and 2k keys (it supports ECDSA too but we chose to not use that
here).</p></div>
<div class="paragraph"><p>By setting some name constraints, we are trying to limit to powers of
this CA.  This is not fully supported by all environments, but it
should do no harm, and may be useful in some environments.</p></div>
<div class="paragraph"><p>The root also has a path length constraint of 1 to prevent the Sub-CAs
from issuing further Sub-Sub-CAs.</p></div>
<div class="paragraph"><p>We also set a expiry date far away in the future on the root CA
(expiring in 1000000 days) and use datefudge to set an arbitrary start
date for the CA, to avoid leaking the time of CA creation which would
leak some bits of information going into the randomness generation.</p></div>
</div>
<div class="sect2">
<h3 id="_preparations">Preparations</h3>
<div class="paragraph"><p>We use OpenSSL to generate keys and certificates.  This is done on an
offline machine, booted from a LiveCD.  Some additional packages may
be required (pcscd, etc, see below) and will have to be transferred on
a USB stick.</p></div>
<div class="paragraph"><p>You need a YubiKey with the PIV application on, which you can purchase
from Yubico.</p></div>
<div class="paragraph"><p>You need to install the PKCS#11 Engine:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-hash"></span>dpkg -i libengine-pkcs11-openssl*
</pre>
</div></div>
<div class="paragraph"><p>or if you are on a connected machine, more simpler:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-hash"></span>apt-get install libengine-pkcs11-openssl
</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_creating_a_root_ca">Creating a Root CA</h3>
<div class="paragraph"><p>Generate the private key as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl genrsa -out yubico-internal-https-ca-key.pem 3744
</pre>
</div></div>
<div class="paragraph"><p>Generate the Root CA certificate and initialize the CA serial number
counter as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>cat&gt;yubico-internal-https-ca.conf&lt;&lt;EOF
[ req ]
x509_extensions = v3_ca
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=Yubico Internal HTTPS CA
[ v3_ca ]
subjectKeyIdentifier=hash
basicConstraints=critical,CA:true,pathlen:1
keyUsage=critical,keyCertSign,cRLSign
nameConstraints=critical,@nc
[ nc ]
permitted;otherName=1.3.6.1.5.5.7.8.7;IA5:yubico.com
permitted;email.0=yubico.com
permitted;email.1=.yubico.com
permitted;DNS=yubico.com
permitted;URI.0=yubico.com
permitted;URI.1=.yubico.com
permitted;IP.0=0.0.0.0/255.255.255.255
permitted;IP.1=::/ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
EOF
<span class="sh-dollar"></span>datefudge "2014-01-01 UTC" openssl req -new -sha256 -x509 -set_serial 1 -days 1000000 -config yubico-internal-https-ca.conf -key yubico-internal-https-ca-key.pem -out yubico-internal-https-ca-crt.pem
<span class="sh-dollar"></span>echo 01 &gt; yubico-internal-https-ca-crt.srl
</pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated root CA with:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl x509 -text &lt; yubico-internal-https-ca-crt.pem
</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_preparing_a_sub_ca">Preparing a Sub-CA</h3>
<div class="paragraph"><p>We need to change the management key, PIN and PUK code following the
YubiKey-PIV-Introduction.txt document.  We also want to save a
copy of these values.  Here are the steps that are needed to be done
for each new Sub-CA.</p></div>
<div class="paragraph"><p>This step is parametrized with the name of the YubiKey user.
Generate new management code, PIN and PUK as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>user=Simon
<span class="sh-dollar"></span>key=`dd if=/dev/urandom 2&gt;/dev/null | tr -d '[:lower:]' | tr -cd '[:xdigit:]' | fold -w48 | head -1`
<span class="sh-dollar"></span>echo $key &gt; yubico-internal-https-$user-key.txt
<span class="sh-dollar"></span>pin=`dd if=/dev/urandom 2&gt;/dev/null | tr -cd '[:digit:]' | fold -w6 | head -1`
<span class="sh-dollar"></span>echo $pin &gt; yubico-internal-https-$user-pin.txt
<span class="sh-dollar"></span>puk=`dd if=/dev/urandom 2&gt;/dev/null | tr -cd '[:digit:]' | fold -w8 | head -1`
<span class="sh-dollar"></span>echo $puk &gt; yubico-internal-https-$user-puk.txt
</pre>
</div></div>
<div class="paragraph"><p>Configure a fresh YubiKey with these parameters as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -a set-mgm-key -n $key
<span class="sh-dollar"></span>yubico-piv-tool -k $key -a change-pin -P 123456 -N $pin
<span class="sh-dollar"></span>yubico-piv-tool -k $key -a change-puk -P 12345678 -N $puk
</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_creating_a_sub_ca">Creating a Sub-CA</h3>
<div class="paragraph"><p>This step is parametrized with the name of the YubiKey user.  This
means we will have one Sub-CA for every person authorized to sign
certificates in our CA.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>user=Simon
</pre>
</div></div>
<div class="paragraph"><p>We first need to load the management key and PIN code from the
previous section.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>key=`cat yubico-internal-https-$user-key.txt`
<span class="sh-dollar"></span>pin=`cat yubico-internal-https-$user-pin.txt`
</pre>
</div></div>
<div class="paragraph"><p>Generate the private key:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl genrsa -out yubico-internal-https-subca-$user-key.pem 2048
</pre>
</div></div>
<div class="paragraph"><p>Generate the Sub-CA certificate request:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>cat&gt;yubico-internal-https-subca-$user-csr.conf&lt;&lt;EOF
[ req ]
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=Yubico Internal HTTPS $user Sub-CA
EOF
<span class="sh-dollar"></span>openssl req -sha256 -new -config yubico-internal-https-subca-$user-csr.conf -key yubico-internal-https-subca-$user-key.pem -nodes -out yubico-internal-https-subca-$user-csr.pem
</pre>
</div></div>
<div class="paragraph"><p>Generate the Sub-CA certificate:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>cat&gt;yubico-internal-https-subca-$user-crt.conf&lt;&lt;EOF
basicConstraints = critical, CA:true, pathlen:0
keyUsage=critical, keyCertSign
EOF
<span class="sh-dollar"></span>openssl x509 -sha256 -CA yubico-internal-https-ca-crt.pem -CAkey yubico-internal-https-ca-key.pem -req -in yubico-internal-https-subca-$user-csr.pem -extfile yubico-internal-https-subca-$user-crt.conf -out yubico-internal-https-subca-$user-crt.pem
<span class="sh-dollar"></span>echo 00 &gt; yubico-internal-https-subca-$user-crt.srl
</pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated EE cert with this command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl x509 -text &lt; yubico-internal-https-subca-$user-crt.pem
</pre>
</div></div>
<div class="paragraph"><p>Import Sub-CA key to the YubiKey:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -k $key -a import-key -s 9c &lt; yubico-internal-https-subca-$user-key.pem
</pre>
</div></div>
<div class="paragraph"><p>Import Sub-CA cert to the YubiKey:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -k $key -a import-certificate -s 9c &lt; yubico-internal-https-subca-$user-crt.pem
</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_creating_end_entity_certificates">Creating End-Entity Certificates</h3>
<div class="paragraph"><p>This step is parametrized with the hostname, and the name of the
Sub-CA used to sign the EE, so set it first:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>host=munin
<span class="sh-dollar"></span>user=Simon
</pre>
</div></div>
<div class="paragraph"><p>We first need to load the PIN code from the previous section.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>pin=`cat yubico-internal-https-$user-pin.txt`
</pre>
</div></div>
<div class="paragraph"><p>Then generate a new private key and certificate request:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl genrsa -out yubico-internal-https-ee-$host-key.pem 2048
<span class="sh-dollar"></span>cat&gt;yubico-internal-https-ee-$host-csr.conf&lt;&lt;EOF
[ req ]
distinguished_name = req_distinguished_name
prompt = no
[ req_distinguished_name ]
CN=$host.yubico.com
EOF
<span class="sh-dollar"></span>openssl req -sha256 -new -config yubico-internal-https-ee-$host-csr.conf -key yubico-internal-https-ee-$host-key.pem -nodes -out yubico-internal-https-ee-$host-csr.pem
</pre>
</div></div>
<div class="paragraph"><p>Then sign the certificate using the:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>cat&gt;yubico-internal-https-ee-$host-crt.conf&lt;&lt;EOF
basicConstraints = critical,CA:false
keyUsage=critical,digitalSignature,keyEncipherment
extendedKeyUsage=critical,serverAuth
subjectAltName=critical,DNS:$host.yubico.com
EOF
<span class="sh-dollar"></span>openssl &lt;&lt; EOF
engine dynamic -pre SO_PATH:/usr/lib/engines/engine_pkcs11.so -pre ID:pkcs11 -pre NO_VCHECK:1 -pre LIST_ADD:1 -pre LOAD -pre MODULE_PATH:/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so -pre VERBOSE
x509 -engine pkcs11 -CAkeyform engine -CAkey slot_1-id_2 -sha256 -CA yubico-internal-https-subca-$user-crt.pem -req -passin pass:$pin -in yubico-internal-https-ee-$host-csr.pem -extfile yubico-internal-https-ee-$host-crt.conf -out yubico-internal-https-ee-$host-crt.pem
EOF
</pre>
</div></div>
<div class="paragraph"><p>You may inspect the newly generated EE cert with this command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl x509 -text &lt; yubico-internal-https-ee-$host-crt.pem
</pre>
</div></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>