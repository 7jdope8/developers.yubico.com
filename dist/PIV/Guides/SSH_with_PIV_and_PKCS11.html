<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>SSH with PIV and PKCS11</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li class="active"><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/PIV">PIV</a></li>
<li><a href="/PIV/Guides">Guides</a></li>
<li class="active">SSH with PIV and PKCS11</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/PIV">PIV</a><ul class="">
<li><a href="/PIV/Introduction">Introduction</a></li>
<li><a href="/PIV/Tools">Tools</a></li>
<li class="active"><a href="/PIV/Guides">Guides</a><ul class="">
<li><a href="/PIV/Guides/Device_setup.html">Device setup</a></li>
<li><a href="/PIV/Guides/Certificate_authority.html">Certificate authority</a></li>
<li class="active"><a href="/PIV/Guides/SSH_with_PIV_and_PKCS11.html">SSH with PIV and PKCS11</a>
<li><a href="/PIV/Guides/SSH_user_certificates.html">SSH user certificates</a></li>
<li><a href="/PIV/Guides/Windows_CA_issued_certificate.html">Windows CA issued certificate</a></li>
<li><a href="/PIV/Guides/Android_code_signing.html">Android code signing</a></li>
<li><a href="/PIV/Guides/Generating_keys_using_OpenSSL.html">Generating keys using OpenSSL</a></li>
<li><a href="/PIV/Guides/Mac_code_signing.html">Mac code signing</a></li>
</li></ul>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/developers.yubico.com/issues/new?title=Suggested%20edit%20for%20PIV/Guides/SSH_with_PIV_and_PKCS11" rel="noopener noreferrer" target="_blank"><i class="fa fa-pencil-square-o fa-lg"></i> Suggest Edits</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_using_piv_for_ssh_through_pkcs11">Using PIV for SSH through PKCS11</h1>
<div class="sectionbody">
<div class="paragraph"><p>This is a step-by-step for how to get a YubiKey with PIV to work for
public-key authentication with OpenSSH through PKCS11.
Primarily on a OS X or Linux system.</p></div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="ulist"><ul>
<li>
<p>
a YubiKey with the PIV application loaded
</p>
</li>
<li>
<p>
the yubico-piv-tool software
</p>
</li>
<li>
<p>
the OpenSC software
</p>
</li>
<li>
<p>
OpenSSH
</p>
<div class="ulist"><ul>
<li>
<p>
If you are using OSX El Capitan (10.11) or earlier, for ssh-agent to work a newer OpenSSH than is delivered with the system; macOS Sierra (10.12) contains a compatible version
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The following example assume that you have not yet changed the management key. If you have changed the management key, add <code>--key</code> to the <code>yubico-piv-tool -a import-certificate</code> command below.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_steps">Steps</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Generate or import a key in slot 9a (any slot should suffice):
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Import the key (PEM format):
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -s 9a -a import-key -i key.pem
</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If an external key is imported and there already exists a certificate step 2 can be skipped.</td>
</tr></table>
</div>
</li>
<li>
<p>
Generate the key:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -s 9a -a generate -o public.pem
</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">RSA 4096-bit keys are not currently supported due to a limitation in the PIV spec: <a href="https://github.com/Yubico/yubico-piv-tool/issues/58" rel="noopener noreferrer" target="_blank">https://github.com/Yubico/yubico-piv-tool/issues/58</a></td>
</tr></table>
</div>
</li>
</ol></div>
</li>
<li>
<p>
Create a self-signed certificate for that key.
The only use for the X.509 certificate is to make PIV/PKCS#11 lib happy.
They would want to be able to extract the public-key from the smartcard,
and do that through the X.509 certificate.
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -a verify-pin -a selfsign-certificate -s 9a -S "/CN=SSH key/" -i public.pem -o cert.pem
</pre>
</div></div>
</li>
<li>
<p>
Load the certificate:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubico-piv-tool -a import-certificate -s 9a -i cert.pem
</pre>
</div></div>
</li>
<li>
<p>
Find out where OpenSC has installed the pkcs11 module.
</p>
<div class="ulist"><ul>
<li>
<p>
For OS X with binary installation this is typically in <code>/Library/OpenSC/lib/</code>. Homebrew users can use:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo ln `brew list opensc | grep lib/opensc-pkcs11.so` /usr/local/lib/opensc-pkcs11.so
</pre>
</div></div>
</li>
<li>
<p>
For a Debian based system this is typically in <code>/usr/lib/x86_64-linux-gnu/</code>
</p>
<div class="paragraph"><p>After this we’ll call this location <code>$OPENSC_LIBS</code></p></div>
</li>
</ul></div>
</li>
<li>
<p>
Export the public key in correct format for ssh and once you got it,
add it to authorized_keys on the target system.
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh-keygen -D $OPENSC_LIBS/opensc-pkcs11.so -e
</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The command will export all keys stored on the YubiKey Neo.
Hopefully it will keep the slot order so it should be not hard to guess which
is the public key associated with your targeted private key.</td>
</tr></table>
</div>
</li>
<li>
<p>
Authenticate to the target system using the new key:
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh -I $OPENSC_LIBS/opensc-pkcs11.so user@remote.example.com
</pre>
</div></div>
</li>
<li>
<p>
This can also be setup to work with ssh-agent: (Optional)
</p>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh-add -s $OPENSC_LIBS/opensc-pkcs11.so
</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">On OS X prior to macOS 10.12 “Sierra” this typically requires installation of a third-party OpenSSH from Homebrew or the like and using that ssh-agent.</td>
</tr></table>
</div>
<div class="paragraph"><p>To confirm that the ssh-agent correctly finds that key and getting the public key in correct format:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh-add -L
</pre>
</div></div>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>