<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Installation</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubikey-val">yubikey-val</a></li>
<li class="active">Installation</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubikey-val">yubikey-val</a><ul class="">
<li><a href="/yubikey-val/Release_Notes.html">Release Notes</a></li>
<li class="active"><a href="/yubikey-val/Installation.html">Installation</a>
<li><a href="/yubikey-val/Troubleshooting.html">Troubleshooting</a></li>
<li><a href="/yubikey-val/Client_Info_Format.html">Client Info Format</a></li>
<li><a href="/yubikey-val/Generating_Clients.html">Generating Clients</a></li>
<li><a href="/yubikey-val/Getting_Started_Writing_Clients.html">Getting Started Writing Clients</a></li>
<li><a href="/yubikey-val/Import_Export_Data.html">Import Export Data</a></li>
<li><a href="/yubikey-val/Make_Release.html">Make Release</a></li>
<li><a href="/yubikey-val/Munin_Probes.html">Munin Probes</a></li>
<li><a href="/yubikey-val/Revocation_Service.html">Revocation Service</a></li>
<li><a href="/yubikey-val/Server_Replication_Protocol.html">Server Replication Protocol</a></li>
<li><a href="/yubikey-val/Sync_Monitor.html">Sync Monitor</a></li>
<li><a href="/yubikey-val/Validation_Protocol_V2.0.html">Validation Protocol V2.0</a></li>
<li><a href="/yubikey-val/Validation_Server_Algorithm.html">Validation Server Algorithm</a></li>
<li><a href="/yubikey-val/YubiKey_Info_Format.html">YubiKey Info Format</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubikey-val" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_introduction">Introduction</h1>
<div class="sectionbody">
<div class="paragraph"><p>This document describes how to get one instance of the Yubikey
Validation Server (YK-VAL) up and running.</p></div>
<div class="paragraph"><p>The purpose of the Yubikey validation server is to validate Yubikey
OTPs.  The validation server is written in PHP, and thus needs a web
server and a database.  We will use Apache and MySQL, but with small
modifications it should be possible to use with other implementations
too (e.g., lighttpd and PostgreSQL).</p></div>
<div class="paragraph"><p>The validation server needs to talk to a Yubikey Key Storage Module
(YK-KSM) to work.  Thus, you either need to arrange for access to a
remote YK-KSM and get the URL to it, or install your own YK-KSM.</p></div>
<div class="paragraph"><p>Currently there are two recommended implementations of a YK-KSM. If
you have a YubiHSM hardware dongle and want improve security, we
recommend using
<a href="https://developers.yubico.com/python-pyhsm/">Python-PyHSM</a>.</p></div>
<div class="paragraph"><p>Otherwise we recommend the "soft"
<a href="https://developers.yubico.com/yubikey-ksm/">YK-KSM</a></p></div>
<div class="paragraph"><p>The YK-KSM can be on the same machine as the validation server, but
for improved security we recommend to use different machines for the
validation server and the KSM.</p></div>
<div class="paragraph"><p>The OTP validation service is delivered through web service API.
There’s no web-based HTML form interface involved.  The protocol is
defined at: <a href="http://www.yubico.com/developers/api/" rel="noopener noreferrer" target="_blank">http://www.yubico.com/developers/api/</a></p></div>
<div class="paragraph"><p>For redundancy it is possible to set up multiple instances of the
YubiKey Validation Server.  The intent is that clients should be able
to continue validate OTPs even if one of the servers are down.  This
is reflected in the configuration of a YK-VAL by having a "sync pool"
concept.  The sync pool of a particular YK-VAL instance is a list of
URLs that the local server will synchronize the OTP with, depending on
client request.  Normally if you have 5 servers, each server will have
a list of the 4 other servers in its sync pool — however it IS
possible to deviate from this if for some reason it is not possible to
reach one particular server from one of the servers.  For simplicity,
we strongly recommend you to list non-local servers in each sync pool
though.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following steps apply to any GNU/Linux-like system, although it
was written for Debian GNU/Linux.  If you do not know which OS to use,
we recommend a default choice of Ubuntu 14.04 LTS since it is a
well-known distribution that comes with 5 years of security support.
Install the OS following its manual and enable automatic security
upgrades if prompted.</p></div>
<div class="sect2">
<h3 id="_step_1_yk_val_installation">Step 1: YK-VAL Installation</h3>
<div class="paragraph"><p>First you should download and install the latest YK-VAL release:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo apt-get install git make
...
user@val:~$ git clone https://github.com/Yubico/yubikey-val.git
...
user@val:~$ <span class="nb">cd</span> yubikey-val
user@val:~/yubikey-val$ sudo make install
</pre></div></div></div>
<div class="paragraph"><p>Depending on your distribution, the group of Apache (or the HTTP server) might
be different from <code>www-data</code>, used in Debian and Ubuntu. On Red Hat, Fedora or
CentOS the group is <code>apache</code> and in SUSE it is <code>www</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~/yubikey-val: sudo make install <span class="nv">wwwgroup</span><span class="o">=</span>apache
</pre></div></div></div>
<div class="paragraph"><p>The rest of this documentation will assume you have YK-VAL available
in the default installation targets.  You can override the paths, see
the Makefile.</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_install_web_server_and_php">Step 2: Install web server and PHP</h3>
<div class="paragraph"><p>You also need to install a web server with PHP5, php5-curl and php-pear.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo apt-get install apache2 php5 php5-curl php-pear
</pre></div></div></div>
<div class="paragraph"><p>Any web server with PHP support should work.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_database_installation">Step 3: Database installation</h3>
<div class="paragraph"><p>Any SQL database with PHP support should work.  We give examples for
MySQL and PostgreSQL here.  Note that you need to chose between either
PostgreSQL or MySQL here.</p></div>
<div class="sect3">
<h4 id="_step_3a_mysql_installation">Step 3A: MySQL Installation</h4>
<div class="paragraph"><p>Install the required packages:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo apt-get install mysql-server php5-mysql
</pre></div></div></div>
<div class="paragraph"><p>The installation asks you for a MySQL "root" password, and I recommend
to specify one. To avoid having to specify a password when using the
<em>mysql</em> tool interactively, you can store the password in <code>~/.my.cnf</code>,
see <code>/usr/share/doc/mysql-server-5.0/README.Debian.gz</code>.  For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ cat &gt; .my.cnf
<span class="o">[</span>client<span class="o">]</span>
<span class="nv">user</span> <span class="o">=</span> root
<span class="nv">password</span> <span class="o">=</span> YOURPASSWORD
user@val:~$ chmod go-r .my.cnf
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>Note the <em>chmod</em> to protect your password from non-root users.</p></div>
<div class="paragraph"><p>The database needs to be initialized as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ <span class="nb">echo</span> <span class="s1">'create database ykval'</span> <span class="p">|</span> mysql
user@val:~$ mysql ykval &lt; /usr/share/doc/yubikey-val/ykval-db.sql
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You also need to create a database user for the verifier interface,
normally called <em>ykval_verifier</em>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ mysql --silent ykval
mysql&gt; CREATE USER <span class="s1">'ykval_verifier'</span>@<span class="s1">'localhost'</span><span class="p">;</span> <span class="se">\</span>
GRANT SELECT,INSERT,UPDATE<span class="o">(</span>modified, yk_counter, yk_low, yk_high, yk_use, nonce<span class="o">)</span> ON ykval.yubikeys TO <span class="s1">'ykval_verifier'</span>@<span class="s1">'localhost'</span><span class="p">;</span> <span class="se">\</span>
GRANT SELECT,INSERT,UPDATE<span class="o">(</span>id, secret, active<span class="o">)</span> ON ykval.clients TO <span class="s1">'ykval_verifier'</span>@<span class="s1">'localhost'</span><span class="p">;</span> <span class="se">\</span>
GRANT SELECT,INSERT,UPDATE,DELETE ON ykval.queue TO <span class="s1">'ykval_verifier'</span>@<span class="s1">'localhost'</span><span class="p">;</span> <span class="se">\</span>
SET PASSWORD FOR <span class="s1">'ykval_verifier'</span>@<span class="s1">'localhost'</span> <span class="o">=</span> PASSWORD<span class="o">(</span><span class="s1">'yourpassword'</span><span class="o">)</span><span class="p">;</span> <span class="se">\</span>
FLUSH PRIVILEGES<span class="p">;</span>
mysql&gt; <span class="se">\q</span>
user@val:~$
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_step_3b_postgresql_installation">Step 3B: PostgreSQL Installation</h4>
<div class="paragraph"><p>Install the required packages:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo apt-get install postgresql php5-pgsql
...
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>The database needs to be initialized as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo su postgres
postgres@val:~$ createdb ykval
postgres@val:~$ psql ykval &lt; /usr/share/doc/yubikey-val/ykval-db.sql
postgres@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You also need to create a database user for the verifier interface,
normally called <em>ykval_verifier</em>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>postgres@val:~$ psql ykval -q
<span class="nv">ykval</span><span class="o">=</span><span class="c1"># CREATE USER ykval_verifier PASSWORD 'yourpassword';</span>
<span class="nv">ykval</span><span class="o">=</span><span class="c1"># GRANT SELECT,INSERT,UPDATE ON yubikeys TO ykval_verifier;</span>
<span class="nv">ykval</span><span class="o">=</span><span class="c1"># GRANT SELECT,INSERT,UPDATE ON clients TO ykval_verifier;</span>
<span class="nv">ykval</span><span class="o">=</span><span class="c1"># GRANT SELECT, INSERT, UPDATE, DELETE ON queue TO ykval_verifier;</span>
<span class="nv">ykval</span><span class="o">=</span><span class="c1"># \q</span>
postgres@val:~$
</pre></div></div></div>
<div class="paragraph"><p>Don’t forget to switch back to your normal user</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>postgres@val:~$ <span class="nb">exit</span>
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>During installation and debugging it may be useful to watch the
database log entries:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo tail -F /var/log/postgresql/postgresql-*-main.log <span class="p">&amp;</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_setup_verify_otp_interface">Step 4: Setup Verify OTP Interface</h3>
<div class="paragraph"><p>The interface to verify OTPs is implemented using a PHP script.  You
can place the script under any URL, but we recommend serving it as
<em>http://ykval.example.org/wsapi/verify</em>.  The simplest way to setup
the symlinks is to invoke <em>make symlink</em> in your YK-VAL source tree.
Like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~/yubikey-val$ sudo make symlink
install -d /var/www/wsapi/2.0
ln -sf /usr/share/yubikey-val/ykval-verify.php /var/www/wsapi/2.0/verify.php
ln -sf /usr/share/yubikey-val/ykval-sync.php /var/www/wsapi/2.0/sync.php
user@val:~/yubikey-val$
</pre></div></div></div>
<div class="paragraph"><p>If you want to do it manually, you can invoke the above commands
manually.</p></div>
</div>
<div class="sect2">
<h3 id="_step_5_include_path_configuration">Step 5: Include path configuration</h3>
<div class="paragraph"><p>Set the include path for the queue daemon by creating a file
/etc/default/ykval-queue with the following content:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/default/ykval-queue'</span>
<span class="nv">DAEMON_ARGS</span><span class="o">=</span><span class="s2">"/etc/yubico/val:/usr/share/yubikey-val"</span>
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You also need to set the include path for the PHP scripts running via
Apache, using a .htaccess file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /var/www/wsapi/2.0/.htaccess'</span>
RewriteEngine on
RewriteRule ^<span class="o">([</span>^/<span class="se">\.\?</span><span class="o">]</span>+<span class="o">)(</span><span class="se">\?</span>.*<span class="o">)</span>?$ <span class="nv">$1</span>.php<span class="nv">$2</span> <span class="o">[</span>L<span class="o">]</span>
&lt;IfModule mod_php5.c&gt;
  php_value include_path <span class="s2">".:/etc/yubico/val:/usr/share/yubikey-val"</span>
&lt;/IfModule&gt;
user@val:~$ sudo ln -s <span class="m">2</span>.0/.htaccess /var/www/wsapi/.htaccess
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>The .htaccess file also sets up rewriting from the non-.PHP suffix URL
name to the right script.</p></div>
<div class="paragraph"><p>The paths are the default, if you installed the YK-VAL in some other
place you need to modify the paths.</p></div>
</div>
<div class="sect2">
<h3 id="_step_6_yk_val_configuration">Step 6: YK-VAL Configuration</h3>
<div class="paragraph"><p>You also need to create a ykval-config.php script.  An example file is
included in YK-VAL package as ykval-config.php</p></div>
<div class="paragraph"><p>A template is typically installed in /etc/yubico/val/ykval-config.php-template.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo cp /etc/yubico/val/ykval-config.php-template /etc/yubico/val/ykval-config.php
user@val:~$ sudo emacs -nw /etc/yubico/val/ykval-config.php
</pre></div></div></div>
<div class="paragraph"><p>Be careful about the user permissions and ownership so that unrelated
users on the system cannot read the database password.</p></div>
<div class="paragraph"><p>You will typically need to modify the DSN (<code>__YKVAL_DB_DSN__</code>), database
passwords (<code>__YKVAL_DB_PW__</code>), the sync pool lists (<code>__YKVAL_SYNC_POOL__</code>
and <code>__YKVAL_ALLOWED_SYNC_POOL__</code>), and the YK-KSM URLs inside the
otp2ksmurls function.</p></div>
<div class="paragraph"><p>An example DSN for a MySQL setup:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="x">$baseParams['__YKVAL_DB_DSN__'] = "mysql:dbname=ykval;host=127.0.0.1";</span>
</pre></div></div></div>
<div class="paragraph"><p>An example DSN for a PostgreSQL setup:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="x">$baseParams['__YKVAL_DB_DSN__'] = "pgsql:dbname=ykval;host=127.0.0.1";</span>
</pre></div></div></div>
<div class="paragraph"><p>We recommend to add the hosts in YKVAL_SYNC_POOL as entries in <em>/etc/hosts</em> to avoid network delays caused by DNS-lookups. For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt;&gt; /etc/hosts'</span>
<span class="m">1</span>.2.3.4 api1.example.com
<span class="m">2</span>.3.4.5 api2.example.com
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>To improve database performance you can use persistent database connection so that each request doesn’t require a new connection to be setup. To enable this modify <code>__YKVAL_DB_OPTIONS__</code> as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="x">$baseParams['__YKVAL_DB_OPTIONS__'] = array(PDO::ATTR_PERSISTENT =&gt; true);</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_step_7_apache_configuration">Step 7: Apache configuration</h3>
<div class="paragraph"><p>Create an apache web configuration file for the normal HTTP interface
like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/apache2/sites-available/ykval.conf'</span>
&lt;VirtualHost *:80&gt;
  ServerName api.example.com
  ServerAdmin support@example.com

  DocumentRoot /var/www/
  &lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
  &lt;/Directory&gt;
  &lt;Directory /var/www/&gt;
    Options FollowSymLinks
    AllowOverride All
    Order allow,deny
    allow from all
  &lt;/Directory&gt;

  ErrorLog /var/log/apache2/ykval-error.log
  LogLevel warn

  CustomLog /var/log/apache2/ykval-access.log <span class="s2">"%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""</span>
  ServerSignature On

&lt;/VirtualHost&gt;
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>HTTPS is strictly speaking not required, but we strongly recommend it.</p></div>
<div class="paragraph"><p>You need to install a TLS stack for Apache, there are two popular
options here: mod_gnutls and mod_ssl.  We’ll explain how to install
both, but you will need to decide which one to use.</p></div>
<div class="paragraph"><p>You will need to create a key/certificate for your server using normal
tools like GnuTLS "certtool".  A small howto for !GoDaddy is available
from
<a href="http://permalink.gmane.org/gmane.comp.encryption.gpg.gnutls.devel/4062" rel="noopener noreferrer" target="_blank">http://permalink.gmane.org/gmane.comp.encryption.gpg.gnutls.devel/4062</a>.</p></div>
<div class="sect3">
<h4 id="_step_7a_https_via_mod_gnutls">Step 7A: HTTPS via mod_gnutls</h4>
<div class="paragraph"><p>First install and enable the mod_gnutls module:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo apt-get install libapache2-mod-gnutls
user@val:~$ sudo a2enmod gnutls
Enabling module gnutls.
Run <span class="s1">'/etc/init.d/apache2 restart'</span> to activate new configuration!
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You will need to place the private key in
/etc/ssl/private/api.example.com-key.pem and the certificate chain in
/etc/ssl/private/api.example.com-chain.pem.</p></div>
<div class="paragraph"><p>Create Apache web configuration files:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/apache2/sites-available/ykval-ssl.conf'</span>
Listen <span class="m">443</span>
&lt;VirtualHost *:443&gt;
  ServerName api.example.com
  ServerAdmin support@example.com

  GnuTLSEnable on
  GnuTLSCertificateFile /etc/ssl/private/api.example.com-chain.pem
  GnuTLSKeyFile /etc/ssl/private/api.example.com-key.pem
  GnuTLSPriorities NORMAL

  DocumentRoot /var/www/
  &lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
  &lt;/Directory&gt;
  &lt;Directory /var/www/&gt;
    Options FollowSymLinks
    AllowOverride All
    Order allow,deny
    allow from all
  &lt;/Directory&gt;

  ErrorLog /var/log/apache2/ykval-ssl-error.log
  LogLevel warn

  CustomLog /var/log/apache2/ykval-ssl-access.log <span class="s2">"%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""</span>
  ServerSignature On

&lt;/VirtualHost&gt;
user@val:~$
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_step_7b_https_via_mod_ssl">Step 7B: HTTPS via mod_ssl</h4>
<div class="paragraph"><p>The mod_ssl module is typically installed by default, but you need to
enable it.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo a2enmod ssl
Enabling module ssl.
Run <span class="s1">'/etc/init.d/apache2 restart'</span> to activate new configuration!
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You will need to place the private key in
/etc/ssl/private/api.example.com-key.pem and the certificate chain in
/etc/ssl/private/api.example.com-chain.pem.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/apache2/sites-available/ykval-ssl.conf'</span>
&lt;VirtualHost *:443&gt;
  ServerName api.example.com
  ServerAdmin support@example.com

  SSLEngine on
  SSLCertificateFile /etc/ssl/private/api.example.com-chain.pem
  SSLCertificateChainFile /etc/ssl/private/api.example.com-chain.pem
  SSLCertificateKeyFile /etc/ssl/private/api.example.com-key.pem

  DocumentRoot /var/www/
  &lt;Directory /&gt;
    Options FollowSymLinks
    AllowOverride None
  &lt;/Directory&gt;
  &lt;Directory /var/www/&gt;
    Options FollowSymLinks
    AllowOverride All
    Order allow,deny
    allow from all
  &lt;/Directory&gt;

  ErrorLog /var/log/apache2/ykval-ssl-error.log
  LogLevel warn

  CustomLog /var/log/apache2/ykval-ssl-access.log <span class="s2">"%h %l %u %t \"%r\" %&gt;s %b %D \"%{Referer}i\" \"%{User-Agent}i\""</span>
  ServerSignature On

&lt;/VirtualHost&gt;
user@val:~$
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_common_apache_configuration">Common Apache Configuration</h4>
<div class="paragraph"><p>This step is the same for both mod_gnutls and mod_ssl.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo a2enmod rewrite
Enabling module rewrite.
Run <span class="s1">'/etc/init.d/apache2 restart'</span> to activate new configuration!
user@val:~$ sudo a2dissite default
Site default disabled.
Run <span class="s1">'/etc/init.d/apache2 reload'</span> to activate new configuration!
user@val:~$ sudo a2ensite ykval ykval-ssl
Enabling site ykval.
Enabling site ykval-ssl.
Run <span class="s1">'/etc/init.d/apache2 reload'</span> to activate new configuration!
user@val:~$ sudo /etc/init.d/apache2 restart
user@val:~$
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_8_logging">Step 8: Logging</h3>
<div class="paragraph"><p>The PHP interface uses syslog for logging of incoming requests.  The
facility is LOG_LOCAL0.  To place these messages in a separate file,
you can add the following to /etc/syslog.conf, or if you use rsyslog,
create a file /etc/rsyslog.d/ykval.conf with this content:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/rsyslog.d/ykval.conf'</span>
local0.* -/var/log/ykval.log
user@val:~$ sudo /etc/init.d/rsyslog restart
...
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>The <em>-</em> before the filename avoids syncing the file after each write,
which is recommended for performance.</p></div>
<div class="paragraph"><p>The log file can grow large quickly, so it is a good idea to setup
rotation of log files.  Here is an example that rotates the log file
weekly.  Create a file /etc/logrotate.d/ykval like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/logrotate.d/ykval'</span>
/var/log/ykval.log <span class="o">{</span>
  weekly
        dateext
  compress
  missingok
  rotate <span class="m">9999</span>
  notifempty
  postrotate
    invoke-rc.d rsyslog reload &gt; /dev/null
        endscript
<span class="o">}</span>
user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>You may want to modify the default /etc/logrotate.d/apache2, useful
things to add are <em>dateext</em> and <em>compress</em> and change <em>rotate</em> to
something large if you want to retain logs.</p></div>
</div>
<div class="sect2">
<h3 id="_step_8_1_fix_default_log_optional">Step 8.1: Fix default log (optional)</h3>
<div class="paragraph"><p>Unfortunately, most default syslog configuration, including the
syslog.conf configuration file on Debian, will also log all entries to
/var/log/syslog and/or /var/log/messages.</p></div>
<div class="paragraph"><p>I am not aware of any way to avoid this without modifying these other
rules.  To avoid YK-VAL log entries in these other files, you must
modify the default rules.  For example, edit the following lines of
/etc/rsyslog.conf (or /etc/syslog.conf if you don’t use rsyslog):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>*.<span class="o">=</span>debug<span class="p">;</span><span class="se">\</span>
       auth,authpriv.none<span class="p">;</span><span class="se">\</span>
       news.none<span class="p">;</span>mail.none     -/var/log/debug
*.*<span class="p">;</span>auth,authpriv.none          -/var/log/syslog
*.<span class="o">=</span>info<span class="p">;</span>*.<span class="o">=</span>notice<span class="p">;</span>*.<span class="o">=</span>warn<span class="p">;</span><span class="se">\</span>
       auth,authpriv.none<span class="p">;</span><span class="se">\</span>
       cron,daemon.none<span class="p">;</span><span class="se">\</span>
       mail,news.none          -/var/log/messages
</pre></div></div></div>
<div class="paragraph"><p>Change them into:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>*.<span class="o">=</span>debug<span class="p">;</span><span class="se">\</span>
       auth,authpriv.none<span class="p">;</span><span class="se">\</span>
       news.none<span class="p">;</span>mail.none<span class="p">;</span>local0.none     -/var/log/debug
*.*<span class="p">;</span>auth,authpriv.none,local0.none              -/var/log/syslog
*.<span class="o">=</span>info<span class="p">;</span>*.<span class="o">=</span>notice<span class="p">;</span>*.<span class="o">=</span>warn<span class="p">;</span><span class="se">\</span>
       auth,authpriv.none<span class="p">;</span><span class="se">\</span>
       cron,daemon.none<span class="p">;</span><span class="se">\</span>
       local0.none<span class="p">;</span><span class="se">\</span>
       mail,news.none          -/var/log/messages
</pre></div></div></div>
<div class="paragraph"><p>Idempotent commands to speed this up:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@host:~$ sudo perl -pi -e <span class="s1">'s/;auth,authpriv.none/;auth,local0.none,authpriv.none/'</span> /etc/rsyslog.conf
user@host:~$ sudo perl -pi -e <span class="s1">'s/news.none;mail.none/news.none;local0.none;mail.none/'</span> /etc/rsyslog.conf
user@host:~$ sudo perl -pi -e <span class="s1">'s/cron,daemon.none/cron,daemon.none;local0.none/'</span> /etc/rsyslog.conf
user@host:~$ sudo /etc/init.d/rsyslog restart
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_step_9_start_sync_daemon">Step 9: Start Sync Daemon</h3>
<div class="paragraph"><p>When using yubikey-val in a sync pool, you need to have the ykval-queue
daemon running to ensure that data is synchronized between the servers in
the pool. The easiest way of running this is to simply invoke ykval-queue
in a shell:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo ykval-queue
</pre></div></div></div>
<div class="paragraph"><p>However, the recommended approach is to automate running this process in
the background, by use of an init script or similar. Instructions on doing
so vary depending on your operating system.</p></div>
</div>
<div class="sect2">
<h3 id="_step_10_sync_data_from_an_existing_server_optional">Step 10: Sync data from an existing server (optional)</h3>
<div class="paragraph"><p>If you’re adding a new server to an existing pool, you can synchronize all
YubiKey counter data from one of the existing servers. To do so, the server
you want to sync from needs to be configured to allow it. Do this by editing
/etc/yubico/val/ykval-config.php on the existing server, adding the new
servers IP address to the <code>__YKRESYNC_IPS__</code> setting. You’ll most likely want
to add the IP to the <code>__YKVAL_ALLOWED_SYNC_POOL__</code> setting as well. You also
need to edit this file on the new server, adding the existing server(s) IP
address(es) to <code>__YKVAL_ALLOWED_SYNC_POOL__</code>.</p></div>
<div class="paragraph"><p>Once these permissions have been configured, you can initiate the full sync
by running the following command from the new server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ ykval-synchronize http://&lt;IP or hostname of existing server&gt;/wsapi/2.0/resync all
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_step_11_test_it">Step 11: Test it</h3>
<div class="paragraph"><p>You can test the service by requesting a URL.  Using wget, for example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ wget -q -O - <span class="s1">'http://localhost/wsapi/2.0/verify?id=1&amp;nonce=asdmalksdmlkasmdlkasmdlakmsdaasklmdlak&amp;otp=dteffujehknhfjbrjnlnldnhcujvddbikngjrtgh'</span>
<span class="nv">h</span><span class="o">=</span>/QVWkl5VlcX+Or1A2b3vOeoLEwI<span class="o">=</span>
<span class="nv">t</span><span class="o">=</span><span class="m">2010</span>-05-17T14:48:15Z0355
<span class="nv">otp</span><span class="o">=</span>dteffujehknhfjbrjnlnldnhcujvddbikngjrtgh
<span class="nv">nonce</span><span class="o">=</span>asdmalksdmlkasmdlkasmdlakmsdaasklmdlak
<span class="nv">status</span><span class="o">=</span>NO_SUCH_CLIENT

user@val:~$
</pre></div></div></div>
<div class="paragraph"><p>Naturally, you will need to import client keys into the database for
the verify function to work properly.</p></div>
</div>
<div class="sect2">
<h3 id="_the_end">The End</h3>
<div class="paragraph"><p>You now have a YK-VAL up and running.  See
<a href="https://developers.yubico.com/yubikey-ksm/Server_Hardening.html">https://developers.yubico.com/yubikey-ksm/Server_Hardening.html</a> on how to
improve security of your system.</p></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>