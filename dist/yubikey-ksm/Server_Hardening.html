<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Server Hardening</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubikey-ksm">yubikey-ksm</a></li>
<li class="active">Server Hardening</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubikey-ksm">yubikey-ksm</a><ul class="">
<li><a href="/yubikey-ksm/Release_Notes.html">Release Notes</a></li>
<li><a href="/yubikey-ksm/Decryption_Protocol.html">Decryption Protocol</a></li>
<li><a href="/yubikey-ksm/Design_Goals.html">Design Goals</a></li>
<li><a href="/yubikey-ksm/Generate_KSM_Key.html">Generate KSM Key</a></li>
<li><a href="/yubikey-ksm/Generate_Keys.html">Generate Keys</a></li>
<li><a href="/yubikey-ksm/Import_Keys_To_KSM.html">Import Keys To KSM</a></li>
<li><a href="/yubikey-ksm/Installation.html">Installation</a></li>
<li><a href="/yubikey-ksm/Key_Provisioning_Format.html">Key Provisioning Format</a></li>
<li><a href="/yubikey-ksm/Make_Release.html">Make Release</a></li>
<li class="active"><a href="/yubikey-ksm/Server_Hardening.html">Server Hardening</a>
<li><a href="/yubikey-ksm/Sync_Monitor.html">Sync Monitor</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubikey-ksm" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_server_hardening">Server Hardening</h1>
<div class="sectionbody">
<div class="paragraph"><p>While the defaults should be secure, there are some simple
administrative actions that will increase your overall security.  None
of these steps are required, but we encourage you to read this
document to see if the enhancements are relevant for your environment.</p></div>
<div class="sect2">
<h3 id="_tighten_php_configuration">Tighten PHP configuration</h3>
<div class="paragraph"><p>Tighten the security of the PHP installation by creating a file
/etc/php5/conf.d/harden.ini with the following content:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@host:~$ sudo sh -c <span class="s1">'cat &gt; /etc/php5/conf.d/harden.ini'</span>
<span class="nv">display_errors</span> <span class="o">=</span> Off
<span class="nv">log_errors</span> <span class="o">=</span> On
user@host:~$
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_tighten_apache_configuration">Tighten Apache configuration</h3>
<div class="paragraph"><p>Tighten the security of the Apache installation by making sure
directory listings are disabled globally.  Edit
/etc/apache2/conf.d/security and make sure the following is
uncommented:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="nt">&lt;Directory</span> <span class="nt">/&gt;</span>
  AllowOverride None
  Order Deny,Allow
  Deny from all
<span class="nt">&lt;/Directory&gt;</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_time_synchronization">Time Synchronization</h3>
<div class="paragraph"><p>For logging and (on the validation server) time-stamping it is
important to have synchronized clocks.  Install ntp.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@host:~$ sudo apt-get install ntp
...
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_firewall">Firewall</h3>
<div class="paragraph"><p>There is no reason why the KSM needs to listen to incoming requests
from the entire Internet, and restricting access to the intended
YK-VAL servers are recommended.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@ksm:~$ sudo sh -c <span class="s1">'cat &gt; /etc/network/if-pre-up.d/iptables'</span>
<span class="c1">#!/bin/sh</span>

<span class="c1"># IPv4 firewall:</span>
iptables -F
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -A INPUT -i lo -p all -j ACCEPT
iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp -i eth0 -s <span class="m">1</span>.2.3.4 --dport <span class="m">22</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 -s <span class="m">2</span>.3.4.5 --dport <span class="m">80</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 -s <span class="m">2</span>.3.4.5 --dport <span class="m">443</span> -j ACCEPT

<span class="c1"># IPv6 firewall:</span>
ip6tables -F
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT ACCEPT
ip6tables -A INPUT -i lo -p all -j ACCEPT
ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
ip6tables -A INPUT -p icmpv6 -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 -s <span class="m">2000</span>:1:2::3 --dport <span class="m">22</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 -s <span class="m">2000</span>:2:3::4 --dport <span class="m">80</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 -s <span class="m">2000</span>:2:3::4 --dport <span class="m">443</span> -j ACCEPT

user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
user@ksm:~$
</pre></div></div></div>
<div class="paragraph"><p>Replace 1.2.3.4 (for IPv4) and 2000:1:2::3 (for IPv6) with the address
of the host you want to be able to login from via SSH, and replace
2.3.4.5 (for IPv4) and 2000:2:3::4 (for IPv6) with the address of the
YK-VAL that will be accessing this YK-KSM.  Add more lines for each
validation server and SSH host.</p></div>
<div class="paragraph"><p>For a validation server, you may want to allow HTTP(S) requests from
anyone, but not anything else.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/network/if-pre-up.d/iptables'</span>
<span class="c1">#!/bin/sh</span>

<span class="c1"># IPv4 firewall</span>
iptables -F
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -A INPUT -i lo -p all -j ACCEPT
iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp -i eth0 -s <span class="m">1</span>.2.3.4 --dport <span class="m">22</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 --dport <span class="m">80</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 --dport <span class="m">443</span> -j ACCEPT

<span class="c1"># IPv6 firewall:</span>
ip6tables -F
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT ACCEPT
ip6tables -A INPUT -i lo -p all -j ACCEPT
ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
ip6tables -A INPUT -p icmpv6 -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 -s <span class="m">2000</span>:1:2::3 --dport <span class="m">22</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 --dport <span class="m">80</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 --dport <span class="m">443</span> -j ACCEPT

user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
user@ksm:~$
</pre></div></div></div>
<div class="paragraph"><p>Again, replace 1.2.3.4 (for IPv4) and 2000:1:2::3 (for IPv6) with the
address of the host you want to be able to login from via SSH.</p></div>
<div class="paragraph"><p>If you want to allow SSH and HTTP(S) from everywhere, but nothing
else, try this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@val:~$ sudo sh -c <span class="s1">'cat &gt; /etc/network/if-pre-up.d/iptables'</span>
<span class="c1">#!/bin/sh</span>

<span class="c1"># IPv4 firewall</span>
iptables -F
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -A INPUT -i lo -p all -j ACCEPT
iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp -i eth0 --dport <span class="m">22</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 --dport <span class="m">80</span> -j ACCEPT
iptables -A INPUT -p tcp -i eth0 --dport <span class="m">443</span> -j ACCEPT

<span class="c1"># IPv6 firewall:</span>
ip6tables -F
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT ACCEPT
ip6tables -A INPUT -i lo -p all -j ACCEPT
ip6tables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
ip6tables -A INPUT -p icmpv6 -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 --dport <span class="m">22</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 --dport <span class="m">80</span> -j ACCEPT
ip6tables -A INPUT -p tcp -i eth0 --dport <span class="m">443</span> -j ACCEPT

user@ksm:~$ chmod +x /etc/network/if-pre-up.d/iptables
user@val:~$
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_database_encryption">Database Encryption</h3>
<div class="paragraph"><p>The database contains sensitive information.  If someone is able to
access your machine physically, they may shut it off and steal it with
the goal of reading out the sensitive information.  By encrypting the
disk, you can prevent this.  Note that this does not protect against
an attacker who has physical access to your server and sufficient time
to read out the data from the already running system.</p></div>
<div class="paragraph"><p>Full disk encryption will give you the highest protection, but
requires that you can enter the disk encryption password on each
power-up.  This can be unpractical when your hosting environment is
remote.</p></div>
<div class="paragraph"><p>Partial disk encryption allows the operating system to start up, and
enable you to login to the machine remotely to enter the disk
encryption password.  This is less secure than full disk encryption,
because an attacker could physically disconnect your machine, modify
the operating system to send a copy of the password to the attacker,
but may be sufficient if you keep good track of when your machine is
not working properly.</p></div>
<div class="paragraph"><p>To use partial disk encryption for the database content, we suggest
you install the operating system as normal but create another file
system on an encrypted volume.</p></div>
<div class="paragraph"><p>If you need swap space, be sure to only put the swap on the encrypted
volume too.  Make sure that the database does not start up
automatically on boot, and also make sure that the system does not
attempt to mount your encrypted partition automatically.</p></div>
<div class="paragraph"><p>Setup:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@ksm:~$ sudo apt-get install loop-aes-utils loop-aes-modules-2.6-amd64
...
user@ksm:~$ sudo rmmod loop <span class="o">&amp;&amp;</span> sudo modprobe loop
user@ksm:~$ sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/root/ksm.img <span class="nv">bs</span><span class="o">=</span>1k <span class="nv">count</span><span class="o">=</span>1M
...
user@ksm:~$ sudo losetup -e AES128 /dev/loop0 /root/ksm.img
Password:
user@ksm:~$ sudo mkfs.ext2 -q /dev/loop0
user@ksm:~$ sudo mkdir /ksm
user@ksm:~$ sudo mount /dev/loop0 /ksm
user@ksm:~$ sudo /etc/init.d/postgresql-8.3 stop
...
user@ksm:~$ sudo update-rc.d -f postgresql-8.3 remove
user@ksm:~$ sudo mv /var/lib/postgresql /ksm
user@ksm:~$ sudo ln -s /ksm/postgresql /var/lib/postgresql
user@ksm:~$ sudo sh -c <span class="s1">'cat &gt; /usr/local/sbin/ykksm-start'</span>
<span class="c1">#!/bin/sh</span>
<span class="nb">set</span> -e
<span class="nb">set</span> -x
losetup -e AES128 /dev/loop0 /root/ksm.img
fsck /dev/loop0
mount /dev/loop0  /ksm/
/etc/init.d/postgresql-8.3 start
user@ksm:~$ sudo sh -c <span class="s1">'cat &gt; /usr/local/sbin/ykksm-stop'</span>
<span class="c1">#!/bin/sh</span>
<span class="nb">set</span> -e
<span class="nb">set</span> -x
/etc/init.d/postgresql-8.3 stop
umount /ksm
losetup -d /dev/loop0
user@ksm:~$ sudo chmod +x /usr/local/sbin/ykksm-<span class="o">{</span>start,stop<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Slightly adapted for MySQL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>user@ksm:~$ sudo apt-get install loop-aes-utils loop-aes-modules-2.6-686
...
user@ksm:~$ sudo rmmod loop <span class="o">&amp;&amp;</span> sudo modprobe loop
user@ksm:~$ sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/root/ksm.img <span class="nv">bs</span><span class="o">=</span>1k <span class="nv">count</span><span class="o">=</span>1M
...
user@ksm:~$ sudo losetup -e AES128 /dev/loop0 /root/ksm.img
Password:
user@ksm:~$ sudo mkfs.ext2 -q /dev/loop0
user@ksm:~$ sudo mkdir /ksm
user@ksm:~$ sudo mount /dev/loop0 /ksm
user@ksm:~$ sudo /etc/init.d/mysql stop
user@ksm:~$ sudo update-rc.d -f mysql remove
user@ksm:~$ sudo mv /var/lib/mysql /ksm
user@ksm:~$ sudo ln -s /ksm/mysql /var/lib/mysql
user@ksm:~$ sudo sh -c <span class="s1">'cat &gt; /usr/local/sbin/ykksm-start'</span>
<span class="c1">#!/bin/sh</span>
<span class="nb">set</span> -e
<span class="nb">set</span> -x
losetup -e AES128 /dev/loop0 /root/ksm.img
fsck /dev/loop0
mount /dev/loop0  /ksm/
/etc/init.d/mysql start
user@ksm:~$ sudo sh -c <span class="s1">'cat &gt; /usr/local/sbin/ykksm-stop'</span>
<span class="c1">#!/bin/sh</span>
<span class="nb">set</span> -e
<span class="nb">set</span> -x
/etc/init.d/mysql stop
umount /ksm
losetup -d /dev/loop0
user@ksm:~$ sudo chmod +x /usr/local/sbin/ykksm-<span class="o">{</span>start,stop<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Then in the future, to start the YK-KSM, you will need to login to the
machine and issue the command <em>sudo ykksm-start</em> and enter the disk
encryption password.</p></div>
<div class="paragraph"><p>Again, make sure that you don’t use any unencrypted swap.</p></div>
</div>
<div class="sect2">
<h3 id="_intrusion_detection">Intrusion Detection</h3>
<div class="paragraph"><p>To make some attacks discussed in the previous section harder, make
sure that your system has a hardware intrusion detection system and
that your software is notified when it is triggered.  When the
intrusion detection is triggered, you should stop the database and
unmount the encrypted volume and send out a signal to your
administrators.</p></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>