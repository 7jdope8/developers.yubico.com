<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>YubiKey and SSH via PAM</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubico-pam">yubico-pam</a></li>
<li class="active">YubiKey and SSH via PAM</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubico-pam">yubico-pam</a><ul class="">
<li><a href="/yubico-pam/Release_Notes.html">Release Notes</a></li>
<li><a href="/yubico-pam/Authentication_Using_Challenge-Response.html">Authentication Using Challenge-Response</a></li>
<li><a href="/yubico-pam/MacOS_X_Challenge-Response.html">MacOS X Challenge-Response</a></li>
<li><a href="/yubico-pam/Two_Factor_PAM_Configuration.html">Two Factor PAM Configuration</a></li>
<li><a href="/yubico-pam/Ubuntu_FreeRadius_YubiKey.html">Ubuntu FreeRadius YubiKey</a></li>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_1FA_via_PAM.html">YubiKey and FreeRADIUS 1FA via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_via_PAM.html">YubiKey and FreeRADIUS via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_OpenVPN_via_PAM.html">YubiKey and OpenVPN via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_Radius_via_PAM.html">YubiKey and Radius via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_SELinux_on_Fedora_18_and_up.html">YubiKey and SELinux on Fedora 18 and up</a></li>
<li class="active"><a href="/yubico-pam/YubiKey_and_SSH_via_PAM.html">YubiKey and SSH via PAM</a>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubico-pam" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_introduction">Introduction</h1>
<div class="sectionbody">
<div class="paragraph"><p>The purpose of this document is to guide readers through the configuration
steps to use two factor authentication for SSH using YubiKey. This document
assumes that the reader has advanced knowledge and experience in Linux
system administration, particularly for how PAM authentication mechanism is
configured on a Linux platform.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph"><p>Successful configuration of the Yubico PAM module to support two factor
authentication requires following prerequisites:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
Operating System
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Any Unix operating system which supports PAM
(<a href="http://www.kernel.org/pub/linux/libs/pam" rel="noopener noreferrer" target="_blank">Pluggable Authentication Module</a>)
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Complier
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
<a href="http://gcc.gnu.org" rel="noopener noreferrer" target="_blank">GNU GCC complier</a>
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<a href="https://developers.yubico.com/yubico-c-client">Yubico Client C library</a>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Version 1.5 or later
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<a href="https://developers.yubico.com/yubico-pam">Yubico PAM Module</a>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Version 1.7 or later
</p>
</td>
</tr>
</table></div>
</div>
</div>
<div class="sect1">
<h2 id="_system_requirements">System Requirements</h2>
<div class="sectionbody">
<div class="paragraph"><p>This document illustrates the configuration steps for Fedora Core 8
operating system. However, there steps should work on most other Linux
distributions.</p></div>
<div class="paragraph"><p>The Yubico PAM module for SSH can be downloaded from
<a href="https://developers.yubico.com/yubico-pam/releases.html">here</a>.</p></div>
<div class="paragraph"><p>The Yubico PAM module support two factor authentication for SSH.
The two factor authentication module verifies the user name and password
for the user and the One-Time Password (OTP) generated by YubiKey assigned
to the user.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_build_yubico_c_client_and_pam_yubico">Build yubico-c-client and pam_yubico</h2>
<div class="sectionbody">
<div class="paragraph"><p>Build instructions for yubico-c-client and pam_yubico are found in their
respective README.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_configuration_for_user_and_yubikey_token_id_mapping">Configuration for user and YubiKey token ID mapping</h3>
<div class="paragraph"><p>There are two ways of user and YubiKey token ID mapping. It can be either
done at administrative level or at individual user level.</p></div>
<div class="sect3">
<h4 id="_administrative_level">Administrative Level</h4>
<div class="paragraph"><p>In Administrative level, system administrators hold right to configure the
user and YubiKey token ID mapping. Administrators can achieve this by creating
a new file that contains information about the username and the corresponding
IDs of YubiKey(s) assigned.</p></div>
<div class="paragraph"><p>This file contains user name that is allowed to connect to the system over SSH
and the token id of the YubiKey(s) assigned to that particular user. A user
can be assigned multiple YubiKeys and this multi key mapping is supported by
this file. However, presently there is no logic coded to detect or prevent use
of same YubiKey ID for multiple users.</p></div>
<div class="paragraph"><p>Each record in the file should begin on a new line. The parameters in each
record are separated by <code>:</code> character similar to <code>/etc/passwd</code>.</p></div>
<div class="paragraph"><p>The contents of this file are as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;user name&gt;:&lt;YubiKey token ID&gt;:&lt;YubiKey token ID&gt;: ….</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;user name&gt;:&lt;YubiKey token ID&gt;:&lt;YubiKey token ID&gt;:…..</pre>
</div></div>
<div class="paragraph"><p>e.g.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>paul:indvnvlcbdre:ldvglinuddek
simon:uturrufnjder:hjturefjtehv
kurt:ertbhunjimko</pre>
</div></div>
<div class="paragraph"><p>The mapping file must be created/updated manually before configuration of
Yubico PAM module for SSH authentication.</p></div>
<div class="sect4">
<h5 id="_configuration_of_modified_pam_yubico_so_module_at_administrative_level">Configuration of modified pam_yubico.so module at administrative level</h5>
<div class="paragraph"><p>Append the following line to the beginning of the <code>/etc/pam.d/sshd</code> file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>auth required pam_yubico.so id=16 debug authfile=/path/to/mapping/file</pre>
</div></div>
<div class="paragraph"><p>Make sure you set <code>id=16</code> to the correct API-id for the yubico validation server.</p></div>
<div class="paragraph"><p>After the above configuration changes, whenever a user connects to the server
using any ssh client, the PAM authentication interface will pass the control to
Yubico PAM module. The Yubico PAM module first checks the presence of authfile
argument in PAM configuration. If authfile argument is present, it parses the
corresponding mapping file and  verifies the username with corresponding
YubiKey token id as configured in the mapping file. If valid, the Yubico PAM
module extracts the OTP string and sends it to the Yubico authentication server
or else it reports failure. If authfile argument is present but the mapping
file is not present at the provided path PAM module reports failure. After
successful verification of OTP Yubico PAM module from the Yubico
authentication server, a success code is returned.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_user_level">User Level</h4>
<div class="paragraph"><p>In User level, individual users have the ability to configure YubiKey token
ID assigned to them. Users can achieve this by creating a new file
<code>.yubico/authorized_yubikeys</code> inside their home directories that contains
information about the username and the corresponding IDs of YubiKey(s) assigned
to them. A user can be assigned multiple YubiKeys and the multi key mapping is
supported by this file.</p></div>
<div class="paragraph"><p>This file must contain only one record. The parameters in the record are
separated by <code>:</code> character similar to <code>/etc/passwd</code>. The contents of this file
are as shown below:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;user name&gt;:&lt;YubiKey token ID&gt;:&lt;YubiKey token ID&gt;: ….</pre>
</div></div>
<div class="paragraph"><p>e.g.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>paul:indvnvlcbdre:ldvglinuddek</pre>
</div></div>
<div class="paragraph"><p>The <code>.yubico/authorized_yubikeys</code> file must be created/updated manually and must
be placed inside user’s home directory before configuration of Yubico PAM
module for SSH authentication.</p></div>
<div class="sect4">
<h5 id="_configuration_of_modified_pam_yubico_so_module_at_user_level">Configuration of modified pam_yubico.so module at user level</h5>
<div class="paragraph"><p>Append the following line to the beginning of the <code>/etc/pam.d/sshd</code> file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>auth required pam_yubico.so id=16 debug</pre>
</div></div>
<div class="paragraph"><p>After the above configuration changes, whenever a user connects to the server
using any SSH client, the PAM authentication interface will pass the control
to Yubico PAM module. The Yubico PAM module first verifies the username with
corresponding YubiKey token id as configured in the <code>.yubico/authorized_yubikeys</code>
file that present in the user’s home directory who is trying to assess server
through SSH. If valid, the Yubico PAM module extracts the OTP string and sends
it to the Yubico authentication server or else it reports failure. After
successful verification of OTP Yubico PAM module from the Yubico authentication
server, a success code is returned.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pam_unix_so_configuration">pam_unix.so configuration</h3>
<div class="paragraph"><p>Append <em>try_first_pass</em> parameter to the <em>pam_unix.so</em> module to authenticate
the user with password passed from the preceding auth module.</p></div>
<div class="paragraph"><p>The <em>pam_unix.so</em> module used for authentication is generally located into
<code>/etc/pam.d/system-auth</code> for RedHat based Linux system and into
<code>/etc/pam.d/common-auth</code> for Debian based Linux systems.</p></div>
</div>
<div class="sect2">
<h3 id="_ssh_configuration">SSH configuration</h3>
<div class="paragraph"><p>Edit the sshd configuration file <code>/etc/ssh/sshd_config`_ to disable challenge-
response passwords. Change `challenge-response passwords yes</code> to
<code>challenge-response passwords no</code>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_setup">Test Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_fedora_8">Fedora 8</h3>
<div class="paragraph"><p>Test setup for fedora 8 environment is as follows:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
OS Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Fedora release 8 (Werewolf)
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Kernel Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Kernel version 2.6.23.1-42.fc8
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
OpenSSH Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
openssh-4.7p1-2.fc8
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Yubico PAM Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
pam_yubico-1.7
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect2">
<h3 id="_fedora_6">Fedora 6</h3>
<div class="paragraph"><p>Test setup for fedora 6 environment is as follows:</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
OS Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Fedora Core release 6 (Zod)
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Kernel Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
Kernel version 2.6.18-1.2798.fc6
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
OpenSSH Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
openssh-4.3p2-10
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
Yubico PAM Version
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
pam_yubico-1.7
</p>
</td>
</tr>
</table></div>
</div>
<div class="sect2">
<h3 id="_pam_configuration">PAM configuration</h3>
<div class="paragraph"><p>PAM configuration files in our testing environment are as follows:</p></div>
<div class="sect3">
<h4 id="_etc_pam_d_sshd">/etc/pam.d/sshd</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>auth           required          pam_yubico.so authfile=/etc/yubikeyid id=16 debug
auth           include           system-auth
account        required          pam_nologin.so
account        include           system-auth
password       include           system-auth
session        optional          pam_keyinit.so force revoke
session        include           system-auth
session        required          pam_loginuid.so</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_etc_yubikeyid">/etc/yubikeyid</h4>
<div class="listingblock">
<div class="content monospaced">
<pre>root:indvnvlcbdre:ldvglinuddek
test:ldvglinuddek</pre>
</div></div>
<div class="sect4">
<h5 id="_root_yubico_authorized_yubikeys">/root/.yubico/authorized_yubikeys</h5>
<div class="listingblock">
<div class="content monospaced">
<pre>root:indvnvlcbdre:ldvglinuddek</pre>
</div></div>
<div class="paragraph"><p>Please change PAM configuration settings for SSH as shown above and test the
configuration.</p></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_configuration">Testing the Configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>We assume that you have <em>root</em> and <em>test</em> user configured to access SSH on your
test environment with password <em>secret</em> and <em>pencil</em> respectively.</p></div>
<div class="paragraph"><p>Use any standard SSH client for testing (We used SSH command line utility).</p></div>
<div class="paragraph"><p>Try to login to server with SSH client as configured user:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh -l test localhost
Password: (enter 'pencil' and touch the ldvglinuddek YubiKey)
</pre>
</div></div>
<div class="listingblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh -l root localhost
Password: (enter 'secret' and touch the ldvglinuddek YubiKey)
</pre>
</div></div>
<div class="listingblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>ssh -l root localhost
Password: (enter 'secret' and touch the indvnvlcbdre YubiKey)
</pre>
</div></div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>