<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>MacOS X Challenge-Response</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubico-pam">yubico-pam</a></li>
<li class="active">MacOS X Challenge-Response</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubico-pam">yubico-pam</a><ul class="">
<li><a href="/yubico-pam/Release_Notes.html">Release Notes</a></li>
<li><a href="/yubico-pam/Authentication_Using_Challenge-Response.html">Authentication Using Challenge-Response</a></li>
<li class="active"><a href="/yubico-pam/MacOS_X_Challenge-Response.html">MacOS X Challenge-Response</a>
<li><a href="/yubico-pam/Two_Factor_PAM_Configuration.html">Two Factor PAM Configuration</a></li>
<li><a href="/yubico-pam/Ubuntu_FreeRadius_YubiKey.html">Ubuntu FreeRadius YubiKey</a></li>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_1FA_via_PAM.html">YubiKey and FreeRADIUS 1FA via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_via_PAM.html">YubiKey and FreeRADIUS via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_OpenVPN_via_PAM.html">YubiKey and OpenVPN via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_Radius_via_PAM.html">YubiKey and Radius via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_SELinux_on_Fedora_18_and_up.html">YubiKey and SELinux on Fedora 18 and up</a></li>
<li><a href="/yubico-pam/YubiKey_and_SSH_via_PAM.html">YubiKey and SSH via PAM</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubico-pam" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_setting_up_your_yubikey_for_challenge_response_authentication_on_max_os_x">Setting up your YubiKey for challenge response authentication on Max OS X</h1>
<div class="sectionbody">
<div class="paragraph"><p>This article explains the process to get the challenge-response
authentication possible with newer YubiKeys working on Mac OS X. Since
Mac OS X uses PAM like most other Unix/POSIX systems do, most of this
should apply to other operating systems, too.</p></div>
<div class="sect2">
<h3 id="_getting_yubico_pam">Getting yubico-pam</h3>
<div class="paragraph"><p>First you will have to install yubico-pam and its dependencies
required for challenge-response authentication. Use your
distribution’s package manager to get it, or build from source. If
you’re on OS X you can use <a href="http://www.macports.org" rel="noopener noreferrer" target="_blank">MacPorts</a> to
install yubico-pam:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>sudo port install yubico-pam</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This will probably not work in non-superuser installations
  of MacPorts, because it needs to place the yubico PAM module into
  <code>/usr/lib/pam</code>.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_your_yubikey">Configuring your YubiKey</h3>
<div class="paragraph"><p>The next step would be to set up your YubiKey for challenge-response
authentication, if you haven’t done so already. Although this is
possible with the command line <code>ykpersonalize</code> tool, the GUI "YubiKey
Personalization Tool" is a more comfortable way to do this.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Plug in your YubiKey and start the YubiKey Personalization Tool
</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">YubiKey Personalization Tool shows whether your YubiKey supports challenge-response in the lower right.
2. Click <em>Challenge-Response</em>
3. Select HMAC-SHA1 mode. Apparently Yubico-OTP mode doesn’t work with yubico-pam at the moment.
4. Select the configuration slot you want to use
(this text assumes slot two, but it should be easy enough to adapt the instructions if you prefer slot 1)
5. Select whether you want to require pressing the button for authentication</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If you enable this, you will have to press the button twice for each authentication with yubico-pam. This is because the PAM module does not only send the challenge on file and checks whether the response matches, but also generates a new challenge-response pair on success.
6. Use <em>Variable input</em> as HMAC-SHA1 mode</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Using <em>Fixed 64 byte input</em> for this value made my YubiKey always return the same response regardless of what the challenge was. Since this defies the purpose of challenge-response think twice and test before you use this!
7. Generate a secret key
You won’t need this key again, it’s sufficient to have it on your YubiKey. Note that the YubiKey Personalization Tool by default logs the key to configuration_log.csv in your home directory. Consider turning this off in the settings before writing or shredding the file after writing.
8. Click <em>Write Configuration</em></td>
</tr></table>
</div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_configuring_your_user_account_to_accept_the_yubikey">Configuring your user account to accept the YubiKey</h3>
<div class="paragraph"><p>After setting up your YubiKey you need to configure your account to
accept this YubiKey for authentication. To do this, open a terminal
and run</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-hash"></span>create the directory where ykpamcfg will store the initial challenge
mkdir -m0700 -p ~/.yubico
<span class="sh-hash"></span>get the initial challenge from the YubiKey
ykpamcfg -2
</pre>
</div></div>
<div class="paragraph"><p>If you used slot 1 above, replace -2 with -1. If you configured your
YubiKey to require a button press the LED on the YubiKey will start
blinking; press the button to send a challenge-response
response. <code>ykpamcfg</code> should finish successfully telling you that it
stored the initial challenge somewhere inside your home directory:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Stored initial challenge and expected response in '/path/to/your/home/.yubico/challenge-KEYID'.</pre>
</div></div>
<div class="paragraph"><p>This step will create a file with a challenge and the expected
response (that can only be generated with the secret
key <span class="footnote"><br>[This is also the reason why you should avoid having copies of the key in other places than your YubiKey!]<br/></br></span> )
in your home directory. The PAM module will later open this file, read the
challenge, send it to the connected YubiKey and check whether its
answer matches the one on file. If it does, it generates a new
challenge, asks the YubiKey for the correct response for this
challenge and writes both into the file. This also means that you need
to keep this file secure from other users (which is why we created the
.yubico directory in your home with mode 0700).</p></div>
</div>
<div class="sect2">
<h3 id="_configuring_your_system_to_use_yubico_pam_for_authentication">Configuring your system to use Yubico PAM for authentication</h3>
<div class="paragraph"><p>Linux, Solaris, OS X and most BSD variants use the
<a href="http://en.wikipedia.org/wiki/Pluggable_Authentication_Modules" rel="noopener noreferrer" target="_blank">Pluggable
Authentication Modules</a> (PAM) framework to handle authentication.
Using PAM you can specify which
modules are used for authentication of users and which of them are
required, optional and/or sufficient to authenticate a user. Using PAM
you can for example set up multiple-factor authentication, by chaining
multiple required modules.</p></div>
<div class="paragraph"><p>PAM is configured through files in <code>/etc/pam.d</code> on most systems. Each
file in this directory is used for a specific service, i.e. the file
<code>/etc/pam.d/sudo</code> is used to authenticate users for the <code>sudo</code>
program. Debian, for example, uses include directives in these files
to have a central place to configure authentication; in this case we
are not using this on purpose, because challenge-response
authentication doesn’t work remotely (e.g. via SSH), so we only want
to configure it for services we use when on site.</p></div>
<div class="paragraph"><p>The file format in these files is documented in <code>man 5 pam.conf</code>; it
looks like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>function-class control-flag module-path arguments</pre>
</div></div>
<div class="paragraph"><p>where</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
<strong>function-class</strong>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
is one of <code>auth</code>, <code>account</code>, <code>session</code>, and
  <code>password</code>. Since we only care about authentication with the YubiKey
  and yubico-pam only handles authentication, we will always be using
  <code>auth</code> here.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>control-flag</strong>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
is one of <code>required</code>, <code>sufficient</code>, <code>optional</code> and
  some other values depending on your PAM implementation. If we want
  to make YubiKey challenge-response mandatory but combined with other
  methods (e.g. password), we can use <code>required</code>, if we want
  successful challenge-response to be enough to authenticate a user,
  we can use <code>sufficient</code>. <code>optional</code> is not of any use for us
  in this case.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>module-path</strong>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
selects the module to be used for this authentication
  step. This is used as filename in a directory where pam libraries
  are expected, on OS X e.g. <code>/usr/lib/pam</code>, <code>/usr/lib/security</code> on
  some other systems. We want <code>pam_yubico.so</code> in this case, which will
  load <code>/usr/lib/pam/pam_yubico.so</code>.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>arguments</strong>
<br>
</br></td>
<td class="hdlist2">
<p style="margin-top: 0;">
are passed to the pam module and can be used to
  configure its behavior. See <em>Supported PAM module parameters</em> in
  <a href="https://github.com/Yubico/yubico-pam/blob/master/README" rel="noopener noreferrer" target="_blank">README</a>
  for a list of possible values. Since we want to use
  challenge-response, we add <code>mode=challenge-response</code> and to debug
  the setup initially also <code>debug</code>, separated by spaces. <code>debug</code> can
  safely be removed later.
</p>
</td>
</tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">If you misconfigure your PAM modules here you might lose
  your ability to sudo! Always keep a root shell open to be able to
  revert your changes in case something goes wrong!</td>
</tr></table>
</div>
<div class="paragraph"><p>So, if we wanted to use the YubiKey to allow us to sudo without typing
a password, we would add</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>auth       sufficient     pam_yubico.so mode=challenge-response debug</pre>
</div></div>
<div class="paragraph"><p>To get this working on the loginwindow for local interactive login add
the <code>pam_yubico.so</code> to the <code>pam.d</code> file authorization as the first
line. The whole file might look something like this (example taken
from OS X):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>
<span class="sh-hash"></span>sudo: auth account password session
auth       sufficient     pam_yubico.so mode=challenge-response debug
auth       required       pam_opendirectory.so
account    required       pam_permit.so
password   required       pam_deny.so
session    required       pam_permit.so
</pre>
</div></div>
<div class="paragraph"><p>If we wanted to require successful challenge-response authentication
in addition to the usual password, we can change the <code>sufficient</code> in
the line we added to <code>required</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">In theory you can configure pretty much any service you use
  locally to use challenge-response authentication. In practice, I had
  problems configuring challenge-response into the login window of OS
  X. Keep a rescue disk or a remote root terminal available when
  attempting such configurations, just in case something goes wrong
  and you need to restore the PAM configuration to an old state.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">On Debian it started working for me after accidentally
  getting the file-rights correctly. <code>755</code> for <code>~/.yubico</code> &amp; <code>600</code> for
  the files therein. Otherwise the module can’t find, read and/or
  write to the appropriate files. Your clue is the following debug
  messages.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content monospaced">
<pre>[drop_privs.c:restore_privileges(128)] pam_modutil_drop_priv: -1
[pam_yubico.c:do_challenge_response(542)] could not restore privileges
[pam_yubico.c:do_challenge_response(664)] Challenge response failed: No such file or directory</pre>
</div></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>