<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Ubuntu FreeRadius YubiKey</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubico-pam">yubico-pam</a></li>
<li class="active">Ubuntu FreeRadius YubiKey</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubico-pam">yubico-pam</a><ul class="">
<li><a href="/yubico-pam/Release_Notes.html">Release Notes</a></li>
<li><a href="/yubico-pam/Authentication_Using_Challenge-Response.html">Authentication Using Challenge-Response</a></li>
<li><a href="/yubico-pam/MacOS_X_Challenge-Response.html">MacOS X Challenge-Response</a></li>
<li><a href="/yubico-pam/Two_Factor_PAM_Configuration.html">Two Factor PAM Configuration</a></li>
<li class="active"><a href="/yubico-pam/Ubuntu_FreeRadius_YubiKey.html">Ubuntu FreeRadius YubiKey</a>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_1FA_via_PAM.html">YubiKey and FreeRADIUS 1FA via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_FreeRADIUS_via_PAM.html">YubiKey and FreeRADIUS via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_OpenVPN_via_PAM.html">YubiKey and OpenVPN via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_Radius_via_PAM.html">YubiKey and Radius via PAM</a></li>
<li><a href="/yubico-pam/YubiKey_and_SELinux_on_Fedora_18_and_up.html">YubiKey and SELinux on Fedora 18 and up</a></li>
<li><a href="/yubico-pam/YubiKey_and_SSH_via_PAM.html">YubiKey and SSH via PAM</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubico-pam" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_ubuntu_freeradius_yubikey">Ubuntu FreeRadius YubiKey</h1>
<div class="sectionbody">
<div class="paragraph"><p>Create and login to a fresh Ubuntu 10.04 LTS machine:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>vmbuilder kvm ubuntu \
  --dest /var/lib/libvirt/images/freeradius \
  --proxy http://192.168.1.2/ubuntu \
  --rootsize 10000 \
  --mem 600 \
  --suite lucid \
  --flavour virtual \
  --addpkg unattended-upgrades \
  --addpkg openssh-server \
  --addpkg avahi-daemon \
  --addpkg acpid \
  --ssh-key /root/.ssh/authorized_keys \
  --libvirt qemu:///system \
  --hostname freeradius \
  --bridge br0 \
  --debug
ssh -l root freeradius.local</pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_install_and_configure_software">Install and configure software :</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content monospaced">
<pre>   apt-get install build-essential wget
   apt-get install libpam0g-dev libykclient3 libykclient-dev</pre>
</div></div>
<div class="paragraph"><p>Install PAM module:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   wget http://yubico-pam.googlecode.com/files/pam_yubico-2.4.tar.gz
   tar xfz pam_yubico-2.4.tar.gz
   cd pam_yubico-2.4
   ./configure
   make check install
   ln -s /usr/local/lib/security/pam_yubico.so /lib/security/</pre>
</div></div>
<div class="paragraph"><p>Setup PAM debug log file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   touch /var/run/pam-debug.log
   chmod go+w /var/run/pam-debug.log
   tail -F /var/run/pam-debug.log &amp;</pre>
</div></div>
<div class="paragraph"><p>Install FreeRadius:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   apt-get install freeradius
   /etc/init.d/freeradius stop</pre>
</div></div>
<div class="paragraph"><p>Next we configure FreeRadius. First add this to /etc/freeradius/users:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   DEFAULT Auth-Type = pam</pre>
</div></div>
<div class="paragraph"><p>Then comment out <em>pap</em> and uncomment <em>pam</em> from
/etc/freeradius/sites-available/default.</p></div>
<div class="paragraph"><p>Add to the top of /etc/pam.d/radiusd:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   auth sufficient pam_yubico.so id=1 debug authfile=/etc/yubikey_mapping</pre>
</div></div>
<div class="paragraph"><p>If you want to use HMAC signing, specify the <em>key=</em> field too, like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   auth sufficient pam_yubico.so id=1 key=b64foo debug authfile=/etc/yubikey_mapping</pre>
</div></div>
<div class="paragraph"><p>Create a file /etc/yubikey_mapping (ccccccccltnc is Alice’s YubiKey’s public ID) :</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   alice:ccccccccltnc</pre>
</div></div>
<div class="paragraph"><p>Create a Unix account <em>alice</em>:   XXX should not be necessary?</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   adduser --disabled-password alice</pre>
</div></div>
<div class="paragraph"><p>Just press RET and finally <em>y RET</em> on the prompts.</p></div>
<div class="paragraph"><p>Start radiusd:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   LD_PRELOAD=/lib/libpam.so.0 freeradius -X</pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_authentication">Testing authentication :</h2>
<div class="sectionbody">
<div class="paragraph"><p>Confirm that it works with radtest (use a real OTP from Alice’s YubiKey) :</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>   radtest alice ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef 127.0.0.1 0 testing123</pre>
</div></div>
<div class="paragraph"><p>Output should be like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Sending Access-Request of id 69 to 127.0.0.1 port 1812
        User-Name = "alice"
        User-Password = "ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef"
        NAS-IP-Address = 127.0.1.1
        NAS-Port = 0
rad_recv: Access-Accept packet from host 127.0.0.1 port 1812, id=69, length=20</pre>
</div></div>
<div class="paragraph"><p>PAM debug output should be like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[pam_yubico.c:parse_cfg(404)] called.
[pam_yubico.c:parse_cfg(405)] flags 0 argc 3
[pam_yubico.c:parse_cfg(407)] argv[0]=id=1
[pam_yubico.c:parse_cfg(407)] argv[1]=debug
[pam_yubico.c:parse_cfg(407)] argv[2]=authfile=/etc/yubikey_mapping
[pam_yubico.c:parse_cfg(408)] id=1
[pam_yubico.c:parse_cfg(409)] key=(null)
[pam_yubico.c:parse_cfg(410)] debug=1
[pam_yubico.c:parse_cfg(411)] alwaysok=0
[pam_yubico.c:parse_cfg(412)] verbose_otp=0
[pam_yubico.c:parse_cfg(413)] try_first_pass=0
[pam_yubico.c:parse_cfg(414)] use_first_pass=0
[pam_yubico.c:parse_cfg(415)] authfile=/etc/yubikey_mapping
[pam_yubico.c:parse_cfg(416)] ldapserver=(null)
[pam_yubico.c:parse_cfg(417)] ldap_uri=(null)
[pam_yubico.c:parse_cfg(418)] ldapdn=(null)
[pam_yubico.c:parse_cfg(419)] user_attr=(null)
[pam_yubico.c:parse_cfg(420)] yubi_attr=(null)
[pam_yubico.c:pam_sm_authenticate(452)] get user returned: alice
[pam_yubico.c:pam_sm_authenticate(542)] conv returned: ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef
[pam_yubico.c:pam_sm_authenticate(558)] OTP: ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef ID: ccccccccltnc
[pam_yubico.c:pam_sm_authenticate(583)] ykclient return value (0): Success
[pam_yubico.c:check_user_token(117)] Authorization line: alice:ccccccccltnc
[pam_yubico.c:check_user_token(121)] Matched user: alice
[pam_yubico.c:check_user_token(125)] Authorization token: ccccccccltnc
[pam_yubico.c:check_user_token(128)] Match user/token as alice/ccccccccltnc
[pam_yubico.c:pam_sm_authenticate(625)] done. [Success]</pre>
</div></div>
<div class="paragraph"><p>FreeRadius debug output should be like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>rad_recv: Access-Request packet from host 127.0.0.1 port 38575, id=69, length=89
        User-Name = "alice"
        User-Password = "ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef"
        NAS-IP-Address = 127.0.1.1
        NAS-Port = 0
+- entering group authorize {...}
++[preprocess] returns ok
++[chap] returns noop
++[mschap] returns noop
[suffix] No '@' in User-Name = "alice", looking up realm NULL
[suffix] No such realm "NULL"
++[suffix] returns noop
[eap] No EAP-Message, not doing EAP
++[eap] returns noop
[files] users: Matched entry DEFAULT at line 204
++[files] returns ok
++[expiration] returns noop
++[logintime] returns noop
Found Auth-Type = PAM
+- entering group authenticate {...}
pam_pass: using pamauth string &lt;radiusd&gt; for pam.conf lookup
pam_pass: authentication succeeded for &lt;alice&gt;
++[pam] returns ok
+- entering group post-auth {...}
++[exec] returns noop
Sending Access-Accept of id 69 to 127.0.0.1 port 38575
Finished request 0.
Going to the next request
Waking up in 4.9 seconds.
Cleaning up request 0 ID 69 with timestamp +17
Ready to process requests.</pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_a_otp_replay">Testing a OTP replay :</h2>
<div class="sectionbody">
<div class="paragraph"><p>Run the command again, with the <em>same</em> OTP :</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>radtest alice ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef 127.0.0.1 0 testing123</pre>
</div></div>
<div class="paragraph"><p>Then output should be like this, since the OTP was replayed:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Sending Access-Request of id 32 to 127.0.0.1 port 1812
        User-Name = "alice"
        User-Password = "ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef"
        NAS-IP-Address = 127.0.1.1
        NAS-Port = 0
rad_recv: Access-Reject packet from host 127.0.0.1 port 1812, id=32, length=20</pre>
</div></div>
<div class="paragraph"><p>PAM debug log:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[pam_yubico.c:parse_cfg(404)] called.
[pam_yubico.c:parse_cfg(405)] flags 0 argc 3
[pam_yubico.c:parse_cfg(407)] argv[0]=id=1
[pam_yubico.c:parse_cfg(407)] argv[1]=debug
[pam_yubico.c:parse_cfg(407)] argv[2]=authfile=/etc/yubikey_mapping
[pam_yubico.c:parse_cfg(408)] id=1
[pam_yubico.c:parse_cfg(409)] key=(null)
[pam_yubico.c:parse_cfg(410)] debug=1
[pam_yubico.c:parse_cfg(411)] alwaysok=0
[pam_yubico.c:parse_cfg(412)] verbose_otp=0
[pam_yubico.c:parse_cfg(413)] try_first_pass=0
[pam_yubico.c:parse_cfg(414)] use_first_pass=0
[pam_yubico.c:parse_cfg(415)] authfile=/etc/yubikey_mapping
[pam_yubico.c:parse_cfg(416)] ldapserver=(null)
[pam_yubico.c:parse_cfg(417)] ldap_uri=(null)
[pam_yubico.c:parse_cfg(418)] ldapdn=(null)
[pam_yubico.c:parse_cfg(419)] user_attr=(null)
[pam_yubico.c:parse_cfg(420)] yubi_attr=(null)
[pam_yubico.c:pam_sm_authenticate(452)] get user returned: alice
[pam_yubico.c:pam_sm_authenticate(542)] conv returned: ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef
[pam_yubico.c:pam_sm_authenticate(558)] OTP: ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef ID: ccccccccltnc
[pam_yubico.c:pam_sm_authenticate(583)] ykclient return value (2): YubiKey OTP was replayed (REPLAYED_OTP)
[pam_yubico.c:pam_sm_authenticate(625)] done. [Authentication failure]</pre>
</div></div>
<div class="paragraph"><p>FreeRadius debug log:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>rad_recv: Access-Request packet from host 127.0.0.1 port 55170, id=32, length=89
        User-Name = "alice"
        User-Password = "ccccccccltncdjjifceergtnukivgiujhgehgnkrfcef"
        NAS-IP-Address = 127.0.1.1
        NAS-Port = 0
+- entering group authorize {...}
++[preprocess] returns ok
++[chap] returns noop
++[mschap] returns noop
[suffix] No '@' in User-Name = "alice", looking up realm NULL
[suffix] No such realm "NULL"
++[suffix] returns noop
[eap] No EAP-Message, not doing EAP
++[eap] returns noop
[files] users: Matched entry DEFAULT at line 204
++[files] returns ok
++[expiration] returns noop
++[logintime] returns noop
Found Auth-Type = PAM
+- entering group authenticate {...}
pam_pass: using pamauth string &lt;radiusd&gt; for pam.conf lookup
pam_pass: function pam_authenticate FAILED for &lt;alice&gt;. Reason: Permission denied
++[pam] returns reject
Failed to authenticate the user.
Using Post-Auth-Type Reject
+- entering group REJECT {...}
[attr_filter.access_reject]     expand: %{User-Name} -&gt; alice
 attr_filter: Matched entry DEFAULT at line 11
++[attr_filter.access_reject] returns updated
Delaying reject of request 1 for 1 seconds
Going to the next request
Waking up in 0.5 seconds.
Sending delayed reject for request 1
Sending Access-Reject of id 32 to 127.0.0.1 port 55170
Waking up in 4.9 seconds.
Cleaning up request 1 ID 32 with timestamp +66
Ready to process requests.</pre>
</div></div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>