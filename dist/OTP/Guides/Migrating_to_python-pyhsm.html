<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Migrating to python-pyhsm</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li class="active"><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/OTP">OTP</a></li>
<li><a href="/OTP/Guides">Guides</a></li>
<li class="active">Migrating to python-pyhsm</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/OTP">OTP</a><ul class="">
<li><a href="/OTP/Plugins.html">Plugins</a></li>
<li><a href="/OTP/Libraries">Libraries</a></li>
<li><a href="/OTP/OTPs_Explained.html">OTPs Explained</a></li>
<li class="active"><a href="/OTP/Guides">Guides</a><ul class="">
<li class="active"><a href="/OTP/Guides/Migrating_to_python-pyhsm.html">Migrating to python-pyhsm</a>
<li><a href="/OTP/Guides/Self-hosted_OTP_validation.html">Self-hosted OTP validation</a></li>
</li></ul>
<li><a href="/OTP/Modhex_Converter.html">Modhex Converter</a></li>
<li><a href="/OTP/Specifications">Specifications</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul></ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_migrating_from_yubikey_ksm_to_python_pyshm">Migrating from yubikey-ksm to python-pyshm</h1>
<div class="sectionbody">
<div class="paragraph"><p>This guide will take you through the steps needed to migrate from using the
PHP-based yubikey-ksm to using python-pyhsm. Benefits of using python-pyhsm
include the ability of using a YubiHSM to protect Yubico OTP secrets. We will
assume you have a functioning yubikey-ksm installation with some credentials
which need to be migrated. These instructions are for systems running Ubuntu
Linux. Most of this guide will apply to other distributions as well, but the
commands to install the software may be different.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph"><p>If you are migrating from yubikey-ksm for the purpose of using a YubiHSM to
protect secrets, it is important that you securely wipe the old plaintext
secrets used by yubikey-ksm. It’s strongly recommended that you set up a new
server for yhsm-yubikey-ksm using a YubiHSM in production, and never expose any
plaintext secrets to that machine. Plaintext secrets should only be handled on
a secure computer that is not (and will not be) connected to the Internet.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_installing_python_pyhsm">Installing python-pyhsm</h3>
<div class="paragraph"><p>First we’ll install the python based KSM (Key Storage Module). By default it
will run on a different port than the existing yubikey-ksm, so there is no
issue in having both at the same time:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo apt-get install yhsm-yubikey-ksm
</pre>
</div></div>
<div class="sect3">
<h4 id="_option_1_using_a_yubihsm">Option 1: Using a YubiHSM</h4>
<div class="paragraph"><p>If you have the ability to use a YubiHSM to protect the Yubico OTP secrets then
it is recommended that you do so. You will first have to configure the YubiHSM
with at least 1 key handle with the proper permissions. For detailed
instructions on how to set up a YubiHSM, see the YubiHSM Reference Manual which
is available <a href="https://www.yubico.com/products/yubihsm/" rel="noopener noreferrer" target="_blank">here</a>. For this
guide we will assume key handle 1 will be used, and is configured for at least
OTP decryption (the YSM_AEAD_YUBIKEY_OTP_DECODE permission).</p></div>
<div class="paragraph"><p>Now, we need to configure the yhsm-yubikey-ksm server to use the YubiHSM, and
to start automatically on boot. Start by editing the configuration file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo nano /etc/default/yhsm-yubikey-ksm
</pre>
</div></div>
<div class="paragraph"><p>Change the following values (if you’ve set an unlock passphrase you can
configure that as well):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>YHSM_KSM_ENABLE="true"
YHSM_KSM_KEYHANDLES="1"</pre>
</div></div>
<div class="paragraph"><p>Then save and close the file.</p></div>
</div>
<div class="sect3">
<h4 id="_option_2_storing_the_master_key_on_disk">Option 2: Storing the master key on disk</h4>
<div class="paragraph"><p>If you’re not going to be using a YubiHSM to protect the secrets then you will
have to store a master key in plaintext on disk. This file will be used in lieu
of the YubiHSM device. This is one example of setting up such a file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo mkdir -p /etc/yubico/yhsm
<span class="sh-dollar"></span>sudo nano /etc/yubico/yhsm/keys.json
</pre>
</div></div>
<div class="paragraph"><p>The file should contain a JSON object with key handles mapped to AES keys in
hex format, we will use this example:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>{
  "1": "000102030405060708090a0b0c0d0e0f"
}</pre>
</div></div>
<div class="paragraph"><p>We save and close the file, and we now have a keyhandle "1" set up to use a
dummy AES key. You will want to replace the value used in this example with a
randomly generated key. While you can have multiple key handles, we will stick
to using this single one in this guide. Because we want to limit the access to
this file, we change ownership and permissions of the file to be readable only
by the <code>yhsm-ksmsrv</code> user, which was created during the installation of the
software:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo chown yhsm-ksmsrv /etc/yubico/yhsm/keys.json
<span class="sh-dollar"></span>sudo chmod 400 /etc/yubico/yhsm/keys.json
</pre>
</div></div>
<div class="paragraph"><p>Now, we need to configure the yhsm-yubikey-ksm server to use this file, and to
start automatically on boot. Start by editing the configuration file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo nano /etc/default/yhsm-yubikey-ksm
</pre>
</div></div>
<div class="paragraph"><p>Change the following values:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>YHSM_KSM_ENABLE="true"
YHSM_KSM_DEVICE="/etc/yubico/yhsm/keys.json"
YHSM_KSM_KEYHANDLES="1"</pre>
</div></div>
<div class="paragraph"><p>Then save and close the file.</p></div>
</div>
<div class="sect3">
<h4 id="_verifying_that_yhsm_yubikey_ksm_is_configured_correctly">Verifying that yhsm-yubikey-ksm is configured correctly</h4>
<div class="paragraph"><p>Regardless of if you are using a YubiHSM or not, you have made configuration
changes and now need to restart the yhsm-yubikey-ksm daemon:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo service yhsm-yubikey-val restart
</pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_migrating_existing_data">Migrating existing data</h3>
<div class="paragraph"><p>We will now migrate the existing data from yubikey-ksm to yhsm-yubikey-ksm. In
yubikey-ksm the data is stored in an SQL database, and can be exported using
the <code>ykksm-export</code> command. In yhsm-yubikey-ksm the data is stored encrypted on
the disk, in an AEAD format. You can create these AEAD files using the included
yhsm-import-keys command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo su
<span class="sh-hash"></span>printf "# ykksm 1\n`ykksm-export`" | yhsm-import-keys --key-handles 1 -D /etc/yubico/yhsm/keys.json
</pre>
</div></div>
<div class="paragraph"><p>This will encrypt the plaintext secrets using the given AES key (which should
correspond to key handle 1 in your YubiHSM or keys.json file). The resulting
AEAD files will be created under /var/cache/yubikey-ksm/aeads/, where
yhsm-yubikey-ksm will automatically find them.</p></div>
<div class="sect3">
<h4 id="_verification_of_migrated_data">Verification of migrated data</h4>
<div class="paragraph"><p>We can verify the newly created AEADs by attempting to use them to decrypt an
OTP. For this we need a YubiKey that contains a credential that was already in
the yubikey-ksm database. Using curl, we first attempt to decrypt an OTP using
the existing yubikey-ksm installation:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>curl http://localhost/wsapi/decrypt?otp=internccccccfclhvbdbhudbjhvkidevcnbnblldhjfb
OK counter=0004 low=421d high=52 use=01
</pre>
</div></div>
<div class="paragraph"><p>Now, we try the same OTP using yhsm-yubikey-ksm instead, which (by default)
runs on port 8002:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>curl http://localhost:8002/wsapi/decrypt?otp=internccccccfclhvbdbhudbjhvkidevcnbnblldhjfb
OK counter=0004 low=421d high=52 use=01
</pre>
</div></div>
<div class="paragraph"><p>We got the same result, so the migration was successful.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_yubikey_val_configuration">Updating yubikey-val configuration</h3>
<div class="paragraph"><p>Any instance of yubikey-val which was using our earlier yubikey-ksm
installation should be re-configured to use the new yhsm-yubikey-ksm
installation instead. On all server running yubikey-val, edit the following
file:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo nano /etc/yubico/val/ykval-config.php
</pre>
</div></div>
<div class="paragraph"><p>Locate the otp2ksmurls function near the bottom of the file and make sure any
URL listed there which is pointing to the older yubikey-ksm installation is
updated with the new port. Close the file, and reload the configuration:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo service apache2 reload
</pre>
</div></div>
<div class="paragraph"><p>Verify that this new setup works (this assumes yubikey-val is running on the
same machine):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>curl "http://localhost/wsapi/2.0/verify?id=1&amp;nonce=12345678901234567890&amp;otp=internccccccfclhvbdbhudbjhvkidevcnbnblldhjfb"
h=YD17lqu4gUJO7kqAYXHBekieoyk=
t=2016-11-01T13:05:05Z0392
otp=internccccccfclhvbdbhudbjhvkidevcnbnblldhjfb
nonce=12345678901234567890
sl=0
status=OK
</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>While yubikey-ksm by default listens on any network interface (0.0.0.0),
yhsm-yubikey-ksm only listens to the loopback interface (127.0.0.1) by default.
This means that if yubikey-val is running on a different host than
yhsm-yubikey-val it will not be able to access the KSM without further
configuration. While it is possible to configure yhsm-yubikey-ksm to listen on
any interface, the recommended approach is to not expose it to the Internet to
prevent possible denial of service attacks. Instead, the recommended approach
is to whitelist only your own validation servers to connect to the KSM, using
for example SSH tunnels or firewall rules.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_removing_yubikey_ksm">Removing yubikey-ksm</h3>
<div class="paragraph"><p>Now that we’ve got the old data migrated to yhsm-yubikey-ksm, as well as
verified it, we can remove the old data and yubikey-ksm installation:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>sudo apt-get purge yubikey-ksm
</pre>
</div></div>
<div class="paragraph"><p>During removal, we are prompted to confirm that we want to deconfigure and
delete the yubikey-ksm database tables, which we do. This completes the guide.</p></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>