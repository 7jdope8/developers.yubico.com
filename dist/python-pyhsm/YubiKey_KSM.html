<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>YubiKey KSM</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/python-pyhsm">python-pyhsm</a></li>
<li class="active">YubiKey KSM</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/python-pyhsm">python-pyhsm</a><ul class="">
<li><a href="/python-pyhsm/Release_Notes.html">Release Notes</a></li>
<li><a href="/python-pyhsm/Database_Usage.html">Database Usage</a></li>
<li><a href="/python-pyhsm/Intro.html">Intro</a></li>
<li><a href="/python-pyhsm/Running_Hardware_Tests.html">Running Hardware Tests</a></li>
<li class="active"><a href="/python-pyhsm/YubiKey_KSM.html">YubiKey KSM</a>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/python-pyhsm" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_yubikey_key_storage_module_using_the_yubihsm">YubiKey Key Storage Module using the YubiHSM</h1>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph"><p>The YubiCloud architecture separates the online validation servers where
queries are sent from the place where the actual secret YubiKey AES keys
are stored. The KSM decrypts the YubiKey OTP using the AES key identified
by the "public id" part of the OTP, and return the counter values of the
OTP to the querying validation server, which decides if the OTP is valid
or not.</p></div>
<div class="paragraph"><p>The application "yhsm-yubikey-ksm" bundled with pyhsm is a KSM backend using
the YubiHSM to further protect the AES keys.</p></div>
<div class="paragraph"><p>The interface exposed to the validation servers is a simple REST web
interface, currently implemented using the BaseHTTPServer. It is inter-
changeable with the original PHP based KSM found at
<a href="https://developers.yubico.com/yubikey-ksm/">https://developers.yubico.com/yubikey-ksm/</a></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">The server is currently single threaded, and uses a short timeout
(5 seconds by default) to prevent blocking on bad requests (typically
network problems between a validation server and a KSM).</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Key handle</div>You need to configure the YubiHSM connected to the KSM server with at least
one key handle that has the YSM_AEAD_OTP_DECODE permission flag set.</td>
</tr></table>
</div>
<div class="paragraph"><p>It is preferable to use a separate server (and YubiHSM) to create AEAD:s,
in which case the other YubiHSM will have the same key handle with the
same secret key, but with different permission flags (the appropriate
YSM AEAD generate flags for the type of keys you use).</p></div>
</div>
<div class="sect2">
<h3 id="_installation_on_debian_ubuntu">Installation on Debian/Ubuntu</h3>
<div class="paragraph"><p>You can install the yhsm-yubikey-ksm from the package repositories :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>
<span></span>$ sudo apt-get install yhsm-yubikey-ksm
<span class="sh-dollar"></span>sudo <span class="nv">$EDITOR</span> /etc/default/yhsm-yubikey-ksm
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_non_debian_ubuntu_installation_instructions">Non-Debian/Ubuntu installation instructions</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Install pyhsm (see README in top level of pyhsm)
</p>
</li>
<li>
<p>
Install yhsm-yubikey-ksm into a suitable directory such as /usr/local/sbin/
</p>
</li>
<li>
<p>
Run yhsm-yubikey-ksm --help to see what options are available. You will need to
  supply <strong>--key-handles</strong>, and possibly other parameters (verify --output-dir for
  example).
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_the_aead_files">The AEAD files</h3>
<div class="paragraph"><p>yhsm-yubikey-ksm is supposed to work with at least a couple of million YubiKeys
(although the use of BaseHTTPServer might prove to be a bit too simplistic for
a validation service of that magnitude, since it is not threaded).</p></div>
<div class="paragraph"><p>To keep things (such as adding new keys to a non-stop service) simple, and thereby
hopefully robust, the initial scheme is to use the filesystem as database. We store
the secrets of every YubiKey (22 bytes) in a separate file.</p></div>
<div class="paragraph"><p>The secrets are randomized and encrypted by a YubiHSM (preferably a separate one at
a key provisioning site) so that they are protected from attackers even if they were
to gain administrative access to the server/servers with YubiHSM’s attached to them.</p></div>
<div class="paragraph"><p>The YubiHSM adds a MAC of 8 bytes to the 22 bytes secret data of the YubiKey,
resulting in an AEAD of 30 bytes. This data is opaque by nature to everyone but the
YubiHSM, since it is the only one with the key to decrypt the AEAD.</p></div>
<div class="paragraph"><p>Most filesystems start under-performing if you put a million files in a single
directory. To avoid that, the AEAD file is hashed into a directory for each octet
but the last one in the public ID. This ensures there will never be more than 256
AEAD files in each directory :</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>public id     key handle  AEAD file
ccbbddeeffcc  0x20        /var/cache/yubikey-ksm/aeads/0x20/cc/bb/dd/ee/ff/ccbbddeeffcc</pre>
</div></div>
<div class="paragraph"><p>An important note for storing large numbers of AEAD files in a filesystem is that it
will use up large numbers of inodes. Consideration for this should be taken into
account when setting up the filesystem.</p></div>
</div>
<div class="sect2">
<h3 id="_importing_yubikey_secrets">Importing YubiKey secrets</h3>
<div class="paragraph"><p>If you had a YK-KSM server before getting a YubiHSM, use the export utility to
export all the secrets into a text file of this format :</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-hash"></span>ykksm 1
123456,ftftftcccccc,534543524554,fcacd309a20ce1809c2db257f0e8d6ea,000000000000,,,
...
</pre>
</div></div>
<div class="paragraph"><p>and then use the import utility /usr/sbin/yhsm-import-keys to create AEAD’s for
all YubiKey’s listed in the text file.</p></div>
</div>
<div class="sect2">
<h3 id="_running_without_a_hardware_yubihsm">Running without a hardware YubiHSM</h3>
<div class="paragraph"><p><em>Available in pyhsm 1.1.0 and later.</em></p></div>
<div class="paragraph"><p>It’s also possible to run the yubikey-ksm server without a physical YubiHSM.
This can be useful for testing or staging purposes, or other situations where
is it inpractical or infeasable to use a real YubiHSM.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">When running completely in software the AES keys will be stored in a file
on disk, and can be compromised in the event of an attack.</td>
</tr></table>
</div>
<div class="paragraph"><p>To run without a physical YubiHSM, specify a properly formatted JSON file as
the device when invoking the yhsm-yubikey-ksm executable (this also works for
yhsm-import-keys as well as yhsm-generate-keys). The file should contain the
numeric key-handles associated with the corresponding AES keys, as follows:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>{
  "1": "0000000100020003000400050006000700080009000a000b000c000d000e000f",
  "2": "0000111122223333444455556666777788889999aaaabbbbccccddddeeeeffff"
}</pre>
</div></div>
<div class="paragraph"><p>Keys must be strings that parse into integers corresponding with the numeric
key handles used in the YubiHSM, and values must be the hex representation of
the AES key for each key handle.</p></div>
<div class="paragraph"><p>For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ yhsm-yubikey-ksm -D /path/to/my/secrets.json  <span class="o">[</span>other args here...<span class="o">]</span>
</pre></div></div></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>