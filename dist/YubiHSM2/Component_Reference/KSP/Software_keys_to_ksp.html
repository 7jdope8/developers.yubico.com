<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>Software keys to ksp</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li class="active"><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/YubiHSM2">YubiHSM2</a></li>
<li><a href="/YubiHSM2/Component_Reference">Component Reference</a></li>
<li><a href="/YubiHSM2/Component_Reference/KSP">KSP</a></li>
<li class="active">Software keys to ksp</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/YubiHSM2">YubiHSM2</a><ul class="">
<li><a href="/YubiHSM2/Releases">Releases</a></li>
<li><a href="/YubiHSM2/Product_Overview">Product Overview</a></li>
<li><a href="/YubiHSM2/Concepts">Concepts</a></li>
<li><a href="/YubiHSM2/Commands">Commands</a></li>
<li class="active"><a href="/YubiHSM2/Component_Reference">Component Reference</a><ul class="">
<li><a href="/YubiHSM2/Component_Reference/yubihsm-connector">yubihsm-connector</a></li>
<li><a href="/YubiHSM2/Component_Reference/yubihsm-shell">yubihsm-shell</a></li>
<li><a href="/YubiHSM2/Component_Reference/yubihsm-setup">yubihsm-setup</a></li>
<li><a href="/YubiHSM2/Component_Reference/libyubihsm">libyubihsm</a></li>
<li><a href="/YubiHSM2/Component_Reference/python-yubihsm">python-yubihsm</a></li>
<li><a href="/YubiHSM2/Component_Reference/yubihsm-wrap">yubihsm-wrap</a></li>
<li class="active"><a href="/YubiHSM2/Component_Reference/KSP">KSP</a><ul class="">
<li><a href="/YubiHSM2/Component_Reference/KSP/Code_Signing_Example.html">Code Signing Example</a></li>
<li class="active"><a href="/YubiHSM2/Component_Reference/KSP/Software_keys_to_ksp.html">Software keys to ksp</a>
<li><a href="/YubiHSM2/Component_Reference/KSP/Status_codes.html">Status codes</a></li>
</li></ul>
<li><a href="/YubiHSM2/Component_Reference/PKCS_11">PKCS 11</a></li>
</li></ul>
<li><a href="/YubiHSM2/Usage_Guides">Usage Guides</a></li>
<li><a href="/YubiHSM2/Backup_and_Restore">Backup and Restore</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul></ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_move_software_keys_to_key_storage_provider">Move Software Keys to Key Storage Provider</h1>
<div class="sectionbody">
<div class="paragraph"><p>If the target private key is managed by the Microsoft Software Key Storage Provider, another software provider, or any other Key Storage Provider that allows export via PKCS#12 PFX, it is possible to move your key to the YubiHSM 2, but results may vary.</p></div>
<div class="paragraph"><p>This process relies on using the <code>-repairstore</code> functionality of the <code>certutil</code> command, so the private key <strong>must</strong> only be present via the YubiHSM Key Storage Provider when performing this step.  Please refer to the source storage provider documentation for how to cleanly and completely delete a private key.</p></div>
<div class="paragraph"><p>Because Key Storage Provider implementations differ, we recommend testing this procedure using your existing provider before affecting a live system.</p></div>
<div class="sect2">
<h3 id="_export_your_existing_private_key_and_certificate">Export your Existing Private Key and Certificate</h3>
<div class="paragraph"><p>Refer to your current Key Storage Provider documentation for how to obtain a PKCS#12 PFX export of your certificate and private key.</p></div>
<div class="paragraph"><p>Once you have obtained your PFX file, split the certificate from the PFX file using certutil:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PS1&gt; certutil -split -dump &lt;pfx file&gt;</pre>
</div></div>
<div class="paragraph"><p>This will create a file named <code>&lt;Cert Hash&gt;.crt</code>.</p></div>
<div class="paragraph"><p>If you are moving the key to the YubiHSM 2 on the same machine, you must delete the original private key in your current provider.</p></div>
</div>
<div class="sect2">
<h3 id="_import_the_target_private_key">Import the Target Private Key</h3>
<div class="paragraph"><p>Using the instructions for importing a PFX private key via <code>yubihsm-shell</code>, import the target private key file to your YubiHSM 2.</p></div>
<div class="paragraph"><p>Record the <a href="../../Concepts/Label.html">Label</a> property of your imported key.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">The <code>certutil</code> utility doesn’t provide an easy way to split a key exported from the Software KSP into an un-encrypted PEM file.  It may be necessary to use another tool like OpenSSL to convert the key file to an un-encrypted format for import into the HSM.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_restore_the_target_certificate">Restore the Target Certificate</h3>
<div class="paragraph"><p>Move the target certificate file (<code>&lt;Cert Hash&gt;.crt</code>) to the target machine.</p></div>
<div class="paragraph"><p>Import the certificate to the LocalMachine "My" store via your favorite method.  At this point, the certificate will not have an associated private key.  We’ll use the <code>-repairstore</code> functionality of <code>certutil</code> to re-associate the certificate to the private key.</p></div>
<div class="paragraph"><p>Make sure that the target private key is visible via the YubiHSM KSP, using</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PS1&gt; certutil -key -csp "YubiHSM Key Storage Provider"</pre>
</div></div>
<div class="paragraph"><p>This command will list all private keys (and their corresponding container names — which are equal to the <a href="../../Concepts/Label.html">Label</a> property in the YubiHSM 2) visible to the current Authentication Key.</p></div>
<div class="paragraph"><p>Open an elevated prompt and execute the command</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PS1&gt; certutil -repairstore MY &lt;Cert Hash&gt;</pre>
</div></div>
<div class="paragraph"><p>Verify that the certificate has been associated with the YubiHSM Key Storage Provider and has the correct <code>Key Container</code> property value, by running</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PS1&gt; certutil -store My</pre>
</div></div>
<div class="paragraph"><p>and inspecting the <code>Key Container</code> and <code>Provider</code> properties.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">If you are moving your CA key to the YubiHSM 2 on the same machine, Windows Certificate Services (CertSvc) on the local machine writes the name of the Key Storage Provider to its configuration section in the registry.  When signing requests, the certificate service will fail if the KSP name doesn’t match the name in the registry.</td>
</tr></table>
</div>
<div class="paragraph"><p>To update the KSP name for the local certificate service, open an elevated prompt and execute the commands:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PS1&gt; certutil -setreg CA\CSP\Provider "YubiHSM Key Storage Provider"
PS1&gt; certutil -setreg CA\EncryptionCSP\Provider "YubiHSM Key Storage Provider"</pre>
</div></div>
<div class="paragraph"><p>If you have multiple CAs on the same machine, or prefer to edit the registry directly, these settings can be found under</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>HKLM\System\CurrentControlSet\Services\CertSVC\Configuration\&lt;CA Name&gt;\[CSP | EncryptionCSP]</pre>
</div></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>