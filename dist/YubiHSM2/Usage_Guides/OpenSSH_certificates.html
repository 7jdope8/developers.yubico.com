<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>OpenSSH certificates</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li class="active"><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/YubiHSM2">YubiHSM2</a></li>
<li><a href="/YubiHSM2/Usage_Guides">Usage Guides</a></li>
<li class="active">OpenSSH certificates</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/YubiHSM2">YubiHSM2</a><ul class="">
<li><a href="/YubiHSM2/Releases">Releases</a></li>
<li><a href="/YubiHSM2/Product_Overview">Product Overview</a></li>
<li><a href="/YubiHSM2/Concepts">Concepts</a></li>
<li><a href="/YubiHSM2/Commands">Commands</a></li>
<li><a href="/YubiHSM2/Component_Reference">Component Reference</a></li>
<li class="active"><a href="/YubiHSM2/Usage_Guides">Usage Guides</a><ul class="">
<li><a href="/YubiHSM2/Usage_Guides/Admin_guide.html">Admin guide</a></li>
<li><a href="/YubiHSM2/Usage_Guides/Factory_reset.html">Factory reset</a></li>
<li class="active"><a href="/YubiHSM2/Usage_Guides/OpenSSH_certificates.html">OpenSSH certificates</a>
<li><a href="/YubiHSM2/Usage_Guides/OpenSSL_with_libp11.html">OpenSSL with libp11</a></li>
<li><a href="/YubiHSM2/Usage_Guides/OpenSSL_with_pkcs11_engine.html">OpenSSL with pkcs11 engine</a></li>
<li><a href="/YubiHSM2/Usage_Guides/Using_OpenSC_pkcs11-tool.html">Using OpenSC pkcs11-tool</a></li>
<li><a href="/YubiHSM2/Usage_Guides/YubiHSM_quick_start_tutorial.html">YubiHSM quick start tutorial</a></li>
</li></ul>
<li><a href="/YubiHSM2/Backup_and_Restore">Backup and Restore</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul></ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_openssh_certificates">OpenSSH Certificates</h1>
<div class="sectionbody">
<div class="paragraph"><p>OpenSSH supports a proprietary version of certificates that allow
simple login to hosts.</p></div>
<div class="sect2">
<h3 id="_traditional_method">Traditional Method</h3>
<div class="paragraph"><p>The usual way to enable a user <code>U</code> to access a specific host <code>H</code> using
SSH is to copy the public key of <code>U</code> in a file on <code>H</code> (typically
called <code>authorized_keys</code>).</p></div>
<div class="paragraph"><p>This method suffers from a lack of generality. If another user <code>U'</code>
were to be given access to <code>H</code>, their public key should also be copied
in that same file. At the same time, if <code>U</code> were to be given access to
a different host <code>H'</code>, their public key would have to be added to an
equivalent file on that host.</p></div>
<div class="paragraph"><p>While various automatic provisioning systems have been devised, those
still represent a workaround rather than a solution to the problem.</p></div>
</div>
<div class="sect2">
<h3 id="_openssh_ca">OpenSSH CA</h3>
<div class="paragraph"><p>Since version <code>5.4</code> (released 2010-03-08) OpenSSH has had support for
so-called <em>OpenSSH Certificates</em>.</p></div>
<div class="paragraph"><p>By using these, only one OpenSSH CA public key has to be copied onto
the target host. At that point any user can be granted access to any
such host by giving them a file that contains the following
information: their own public key, a validity period, a list of
usernames that the user it allowed to login as and a digital signature
over the whole content created using the private key of an SSH CA.</p></div>
<div class="paragraph"><p>This file, the SSH Certificate, is then automatically presented to
the SSH server by the SSH client of the user as part of the login
process.</p></div>
</div>
<div class="sect2">
<h3 id="_openssh_certificates_with_yubihsm">OpenSSH Certificates with YubiHSM</h3>
<div class="paragraph"><p>The private key of an SSH CA is a regular private key and can be
stored on a YubiHSM. In fact, OpenSSH has builtin support for signing
SSH Certificates using CA private keys that reside on a hardware token
through the PKCS#11 interface.</p></div>
<div class="paragraph"><p>The YubiHSM however has specific support for signing SSH Certificates
and this guide will describe how to leverage that.</p></div>
</div>
<div class="sect2">
<h3 id="_high_level_description_and_components">High-level Description and components</h3>
<div class="paragraph"><p>A YubiHSM device is able to sign OpenSSH public keys when those are
submitted to the device as part of a specific format that we call
<code>OpenSSH Certificate Request</code>.</p></div>
<div class="paragraph"><p>Such a request is granted (i.e., the signature is computed and
released), if and only if the following two requirements are
fulfilled:</p></div>
<div class="ulist"><ul>
<li>
<p>
the user who sends the request to the device has the right
   privileges to access the OpenSSH CA private key on the device;
</p>
</li>
<li>
<p>
the OpenSSH Certificate Request meets a series of
   pre-defined constraints.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first requirement is fulfilled by making sure that the user
submitting the request (who may not be the same one who generates
the request) can establish a Session with the device through an
Authentication Key that has access to the necessary Domains and has
the necessary Capability set.</p></div>
<div class="paragraph"><p>The second requirement is fulfilled by encoding those pre-defined
constraints in an object with Type <code>Template</code> and Algorithm <code>SSH
Template</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_ssh_template">SSH Template</h3>
<div class="paragraph"><p>An <code>SSH Template</code> is a binary object that can be used to restrict how
and when an SSH CA private key should be used to sign SSH Certificate
Requests.</p></div>
<div class="paragraph"><p>This is a binary object that encodes a series of constraints. Its
format is a collection of Tag-Length-Value tuples whose meaning is
described below:</p></div>
<table class="table table-bordered table-striped tableblock frame-all grid-all" style="
width:100%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top"> Tag Value </th>
<th class="tableblock halign-left valign-top"> Tag Description </th>
<th class="tableblock halign-left valign-top"></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp key algorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp public key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CA key white-list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not before</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x05</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not after</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Principals black-list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"></p></td>
</tr>
</tbody>
</col></col></col></table>
<div class="paragraph"><p>The individual tags are further explained below.</p></div>
<div class="sect3">
<h4 id="_timestamp_key_algorithm">Timestamp Key Algorithm</h4>
<div class="paragraph"><p>The <a href="../Concepts/Algorithms.html">Algorithm</a> of the public key used to
verify timestamp signatures.</p></div>
</div>
<div class="sect3">
<h4 id="_timestamp_public_key">Timestamp Public Key</h4>
<div class="paragraph"><p>The public key used to verify timestamp signatures.</p></div>
</div>
<div class="sect3">
<h4 id="_ca_key_white_list">CA Key White-list</h4>
<div class="paragraph"><p>The list of <a href="../Concepts/Object_ID.html">Object IDs</a> describing
which Asymmetric Keys can be used with this template.</p></div>
</div>
<div class="sect3">
<h4 id="_not_before">Not Before</h4>
<div class="paragraph"><p>The <code>Not Before</code> time offset to be applied to the current time. If a
request contains a time value that is before this computed timestamp,
an error will be returned.</p></div>
</div>
<div class="sect3">
<h4 id="_not_after">Not After</h4>
<div class="paragraph"><p>The <code>Not After</code> time offset to be applied to the current time. If a
request contains a time value that is after this computed timestamp,
an error will be returned.</p></div>
</div>
<div class="sect3">
<h4 id="_principals_black_list">Principals Black-list</h4>
<div class="paragraph"><p>The <code>nul</code>-separated, <code>nul</code>-terminated list of Principals (user names) for which a
certificate will not be issued.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ssh_certificate_request">SSH Certificate Request</h3>
<div class="paragraph"><p>An SSH certificate format is defined by OpenSSH but it is not too
dissimilar from an X.509 certificate. At its core it is a collection
of attributes, a time period, a public key and a signature over all
the data.</p></div>
<div class="paragraph"><p>An SSH Certificate Request is the set of information that must be sent
to a YubiHSM so that it can generate the aforementioned signature.
This consists of all the data present in the certificate (excluding
the signature).</p></div>
<div class="sect3">
<h4 id="_signing_an_ssh_certificate_request">Signing an SSH Certificate Request</h4>
<div class="paragraph"><p>Once an SSH Template has been stored on the YubiHSM and an SSH
Certificate Request has been created, it can be sent to the device for
signing.</p></div>
<div class="paragraph"><p>This is done by issuing the
<a href="../Commands/Sign_Ssh_Certificate.html">Sign SSH Certificate</a>
Command. The parameters required are:</p></div>
<div class="ulist"><ul>
<li>
<p>
the <a href="../Concepts/Object_ID.html">Object ID</a> of the SSH CA key
  which has already been stored on the device
</p>
</li>
<li>
<p>
the <a href="../Concepts/Object_ID.html">Object ID</a> of the SSH
  Template to use in order to validate the request
</p>
</li>
<li>
<p>
the <a href="../Concepts/Algorithms.html">Algorithm</a> to use to produce the
  certificate signature
</p>
</li>
<li>
<p>
the timestamp with the definition of <code>Now</code>
</p>
</li>
<li>
<p>
the signature <code>S~T~</code> over the SSH Certificate Request and the
  timestamp
</p>
</li>
<li>
<p>
the SSH Certificate Request
</p>
</li>
</ul></div>
<div class="paragraph"><p>After the command is issued, the following steps take place in the
YubiHSM. First the the signature <code>S~T~</code> is verified using the public
key present within the specified SSH Template. If the verification is
successful, the value of <code>Now</code> is recorded. Next the SSH Certificate
Request is parsed to extract the <code>Not Before</code> and <code>Not After</code>
timestamps together with the list of Principals. The following checks
are then performed:</p></div>
<div class="ulist"><ul>
<li>
<p>
the ID of the SSH CA key must appear in the SSH CA key white-list
  present in the SSH Template
</p>
</li>
<li>
<p>
the <code>Not Before</code> timestamp in the SSH Certificate Request must be
  greater than or equal to <code>Now</code> plus the <code>Not Before</code> offset
  specified in the SSH Template
</p>
</li>
<li>
<p>
the <code>Not After</code> timestamp in the SSH Certificate Request must be
  less than or equal to <code>Now</code> plus the <code>Not After</code> offset specified in
  the SSH Template
</p>
</li>
<li>
<p>
none of the Principals specified in the SSH Certificate Request must
  appear in the Principals black-list SSH Template
</p>
</li>
</ul></div>
<div class="paragraph"><p>If all the constraints were fulfilled, the YubiHSM will produce a
signature using the Algorithm specified in the command. This signature
can be appended to the SSH Certificate Request to produce a valid SSH
Certificate.</p></div>
</div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>