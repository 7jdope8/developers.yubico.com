<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>YubiHSM quick start tutorial</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li class="active"><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/YubiHSM2">YubiHSM2</a></li>
<li><a href="/YubiHSM2/Usage_Guides">Usage Guides</a></li>
<li class="active">YubiHSM quick start tutorial</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/YubiHSM2">YubiHSM2</a><ul class="">
<li><a href="/YubiHSM2/Releases">Releases</a></li>
<li><a href="/YubiHSM2/Product_Overview">Product Overview</a></li>
<li><a href="/YubiHSM2/Concepts">Concepts</a></li>
<li><a href="/YubiHSM2/Commands">Commands</a></li>
<li><a href="/YubiHSM2/Component_Reference">Component Reference</a></li>
<li class="active"><a href="/YubiHSM2/Usage_Guides">Usage Guides</a><ul class="">
<li><a href="/YubiHSM2/Usage_Guides/Admin_guide.html">Admin guide</a></li>
<li><a href="/YubiHSM2/Usage_Guides/Factory_reset.html">Factory reset</a></li>
<li><a href="/YubiHSM2/Usage_Guides/OpenSSH_certificates.html">OpenSSH certificates</a></li>
<li><a href="/YubiHSM2/Usage_Guides/OpenSSL_with_libp11.html">OpenSSL with libp11</a></li>
<li><a href="/YubiHSM2/Usage_Guides/OpenSSL_with_pkcs11_engine.html">OpenSSL with pkcs11 engine</a></li>
<li><a href="/YubiHSM2/Usage_Guides/Using_OpenSC_pkcs11-tool.html">Using OpenSC pkcs11-tool</a></li>
<li class="active"><a href="/YubiHSM2/Usage_Guides/YubiHSM_quick_start_tutorial.html">YubiHSM quick start tutorial</a>
</li></ul>
<li><a href="/YubiHSM2/Backup_and_Restore">Backup and Restore</a></li>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul></ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_yubihsm_2_practical_guide">YubiHSM 2: Practical Guide</h1>
<div class="sectionbody">
<div class="paragraph"><p>This tutorial will cover:</p></div>
<div class="ulist"><ul>
<li>
<p>
Basic YubiHSM 2 setup
</p>
</li>
<li>
<p>
Connecting to YubiHSM 2
</p>
</li>
<li>
<p>
Generating an Authkey on the device
</p>
</li>
<li>
<p>
Generating an Asymmetric Object
</p>
</li>
<li>
<p>
Generate a Wrapkey
</p>
</li>
<li>
<p>
Exporting/Importing an Object under wrap
</p>
</li>
</ul></div>
<div class="paragraph"><p>The purpose of this tutorial is to demonstrate basic functionalities of different key types: Authentication Key, Asymmetric Key and Wrap Key. We start with a fresh YubiHSM 2 configuration and we will proceed in generating a new Authentication Key.
Then we generate an Asymmetric Key for signing purposes. We will sign an arbitrary amount of data and verify that our signature is correct.
Part of this documentation is to demonstrate how to back up a key on a second YubiHSM 2. We will do so by wrapping the Asymmetric Key and re-importing it into the same device.</p></div>
<div class="paragraph"><p>Before reading this document you should be familiar with concepts such as: <code>Sessions</code>, <code>Domains</code>, <code>Capabilities</code> described in the <a href="../Concepts">Concepts</a> Section.</p></div>
<div class="sect2">
<h3 id="_set_up_the_environment">Set Up the Environment</h3>
<div class="ulist"><ul>
<li>
<p>
Get the latest binaries from <a href="../Releases">SDK download</a>
</p>
</li>
<li>
<p>
Install all libraries
</p>
</li>
<li>
<p>
Make sure your device is accessible by the connector. This is accomplished either by running the connector as a superuser or by using an appropriate <a href="../Component_Reference/yubihsm-connector">udev_rule</a>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_start_up">Start Up</h3>
<div class="paragraph"><p>To physically reset the YubiHSM 2 insert the device while holding the touch sensor for 10 seconds.</p></div>
<div class="paragraph"><p>Start the connector</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubihsm-connector -d
</pre>
</div></div>
<div class="paragraph"><p>Check the status of your connector and device by visiting <code>http://127.0.0.1:12345/connector/status</code> with a browser</p></div>
</div>
<div class="sect2">
<h3 id="_setting_up_yubihsm_2_connection">Setting Up YubiHSM 2 Connection</h3>
<div class="paragraph"><p>Start yubihsm-shell</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>yubihsm-shell
</pre>
</div></div>
<div class="paragraph"><p>Connect to YubiHSM2</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; connect</pre>
</div></div>
<div class="paragraph"><p>Enable keepalive to facilitate usability during first time use (keepalive is enabled by default). Remember that this will consume one session</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; keepalive on</pre>
</div></div>
<div class="paragraph"><p>Enable debug</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; debug all</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sessions">Sessions</h3>
<div class="paragraph"><p>Many commands require a Session ID to be specified. To obtain a Session ID use the <code>session open</code> command followed by an Authentication Key ID and a derivation password.</p></div>
<div class="paragraph"><p>By default the YubiHSM 2 comes with a pre-installed Authentication Key with Object ID <code>1</code> and derivation password <code>password</code>. To open a Session with this Authentication Key use</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; session open 1 password
Created session 0</pre>
</div></div>
<div class="paragraph"><p>The Session ID is the number found in the line directly below a <code>session open</code> command. In the example above the Session ID is <code>0</code>. This value will be used to address the newly created Session.</p></div>
<div class="paragraph"><p>To close a Session use the command <code>session close</code> followed by the Session ID</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; session close 0</pre>
</div></div>
<div class="paragraph"><p>To list the objects in the device use</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; list objects 0</pre>
</div></div>
<div class="paragraph"><p>Note that if you have closed Session 0, the above command will not work. Open a new Session in that case and use the new Session ID in the command above.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_a_new_authentication_key">Adding a New Authentication Key</h3>
<div class="paragraph"><p>Before moving on, make sure you are familiar with concepts of <a href="../Concepts/Capability.html">Capabilities</a> and <a href="../Concepts/Domain.html">Domains</a>.</p></div>
<div class="paragraph"><p>For our example we are going to generate an Authentication Key with selected Capabilities and Domains. Learn more about existing key Types <a href="../Concepts/Object.html">here</a>.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; put authkey 0 2 yubico 1,2,3 generate-asymmetric-key,export-wrapped,get-pseudo-random,put-wrap-key,import-wrapped,delete-asymmetric-key,sign-ecdsa sign-ecdsa,exportable-under-wrap,export-wrapped,import-wrapped password</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">export-wrapped allows to create Objects that can perform the <a href="../Commands/Export_Wrapped.html">Export Wrapped</a> command.<br>
 exportable-under-wrap allows to create Objects that can be exported under wrap.</br></td>
</tr></table>
</div>
<div class="paragraph"><p>Note how the command above has two distinct sets of Capabilities, separated by a space. This is because Authentication Keys, besides having regular Capabilities, also have <a href="../Concepts/Capability.html">Delegated Capabilities</a>.</p></div>
<div class="paragraph"><p>List all Objects to see the newly created Authentication Key</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; list objects 0</pre>
</div></div>
<div class="paragraph"><p>Next, let’s start using our newly created Authentication Key to establish a Session</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; session open 2 password
Created session 1</pre>
</div></div>
<div class="paragraph"><p>The new Session has been assigned Session ID <code>1</code>. We will use this Session ID for most of the commands below.
If at any time the Session is closed or expires because of inactivity, open a new one and use the correct Session ID.</p></div>
</div>
<div class="sect2">
<h3 id="_generate_a_key_for_signing">Generate a Key for Signing</h3>
<div class="paragraph"><p>We now proceed to generate a new Asymmetric Key. In our example we will use this key to sign some data. We will also export the key <em>under wrap</em> to another YubiHSM, for backup purposes.</p></div>
<div class="paragraph"><p>Specifically, we will ask the device to generate an Asymmetric Key with ID <code>100</code> and a given set of Domains and Capabilities. We will also specify the kind of Asymmetric Key that we would like to generate, an EC key using the NIST P-256 curve in this case.</p></div>
<div class="paragraph"><p>The command is</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; generate asymmetric 1 100 label_ecdsa_sign 1,2,3 exportable-under-wrap,sign-ecdsa ecp256</pre>
</div></div>
<div class="paragraph"><p>On success, we will see the message</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Generated Asymmetric key 0x0064</pre>
</div></div>
<div class="paragraph"><p>signifying that an Asymmetric Key with ID <code>0x0064</code> (hexadecimal for 100) was generated.</p></div>
</div>
<div class="sect2">
<h3 id="_prepare_to_sign_with_the_new_asymmetric_key">Prepare to Sign With the New Asymmetric Key</h3>
<div class="paragraph"><p>Assuming we have a file called <code>data.txt</code> containing the data we would like to sign, we will sign it using ECDSA with the Asymmetric Key we generated in the previous step</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; sign ecdsa 1 100 ecdsa-sha256 data.txt</pre>
</div></div>
<div class="paragraph"><p>By default the output is printed to the standard output and consists of a Base64-encoded signature like the one below</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>MEUCIQDrBqS04LN5YdyWGiD4iaEjfl1dn+W4cl97uMMXDpoaiQIgEBe/G/FgP4cumnO3K2XWToAnPvnuVDOnqHPiuUS0q5g=</pre>
</div></div>
<div class="paragraph"><p>This behavior can be changed by using the <code>set outformat</code> and <code>set informat</code> commands, and by specifying an additional output parameter to the <code>sign</code> command.</p></div>
<div class="paragraph"><p>For now we will store the signature as it is in a temporary file so that we will be able to verify it later</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>echo MEUCIQDrBqS04LN5YdyWGiD4iaEjfl1dn+W4cl97uMMXDpoaiQIgEBe/G/FgP4cumnO3K2XWToAnPvnuVDOnqHPiuUS0q5g= &gt;signature.b64
</pre>
</div></div>
<div class="paragraph"><p>Next, we will extract the public key from the Asymmetric Key on the device and write it to the file <code>asymmetric_key.pub</code>, so that we can use it to verify the signature we just created</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; get pubkey 1 100 asymmetric_key.pub</pre>
</div></div>
<div class="paragraph"><p>We are going to use OpenSSL for the verification process. Since the signature that we created before is in Base64 format, we need to convert it first. Do so with</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>base64 -d signature.b64 &gt;signature.bin
</pre>
</div></div>
<div class="paragraph"><p>It is now possible to verify the signature with OpenSSL</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>
<span class="sh-dollar"></span>openssl dgst -sha256 -signature signature.bin -verify asymmetric_key.pub data.txt
Verified OK
</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_export_under_wrap">Export Under Wrap</h3>
<div class="paragraph"><p>Time to export the Asymmetric Key under wrap to a second YubiHSM 2 (in this example, we will export to the same YubiHSM for convenience)</p></div>
<div class="paragraph"><p>To do that we need a Wrap Key, which fundamentally is an AES key. We will use the random number generator built into the YubiHSM to generate the 16 bytes needed for an AES-128 key</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; get random 1 16
9207653411df91fd36c12faa6886d5c4</pre>
</div></div>
<div class="paragraph"><p><strong>The result of this command (the bytes) is considered sensitive data and should be stored safely</strong>.</p></div>
<div class="paragraph"><p>We can now store the Wrap Key on the device with ID <code>200</code> by doing</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; put wrapkey 1 200 label_wrapkey 1,2,3 import-wrapped,export-wrapped sign-ecdsa,exportable-under-wrap 9207653411df91fd36c12faa6886d5c4</pre>
</div></div>
<div class="paragraph"><p>Note that for the upcoming export command to be successful, the Delegated Capabilities of the Wrap Key have to include the Capabilities of the Object being exported. Similarly, for the import command to succeed the Delegated Capabilities of the Wrap Key have to include the Capabilities of the Object being imported.</p></div>
<div class="paragraph"><p>We can now export the Asymmetric Key with ID <code>100</code> using the Wrap Key with ID <code>200</code> and save it to a file called <code>wrapped_asymmetric.key</code></p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; get wrapped 1 200 asymmetric-key 100 wrapped_asymmetric.key</pre>
</div></div>
<div class="paragraph"><p>We are going to re-import the Asymmetric Key on the same device so we need to first delete the existing one</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; delete 1 100 asymmetric-key</pre>
</div></div>
<div class="paragraph"><p>To import the wrapped EC key back into the YubiHSM use</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>yubihsm&gt; put wrapped 1 200 wrapped_asymmetric.key</pre>
</div></div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>