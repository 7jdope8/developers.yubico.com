<!DOCTYPE html>

<!--[if lt IE 7]>    <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>     <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>     <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
<title>YubiHSM Setup</title>
<meta content="" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/main.css" rel="stylesheet">
<link href="/css/pygments.css" rel="stylesheet">
<link href="/css/asciidoc.css" rel="stylesheet">
<link href="/favicon-192x192.png" rel="icon" sizes="192x192">
<script src="/vendor/modernizr/modernizr.js"></script>
<!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create', 'UA-6195355-4', 'auto');ga('send','pageview');
    </script>
</link></link></link></link></link></link></meta></meta></meta></meta></head>
<body>
<!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="/"><img src="/logo.png"/></a>
</div>
<div class="navbar-collapse collapse">
<ul class="nav navbar-nav">
<li><a href="/FIDO2">FIDO2</a></li><li><a href="/OTP">OTP</a></li><li><a href="/U2F">U2F</a></li><li><a href="/OATH">OATH</a></li><li><a href="/PGP">PGP</a></li><li><a href="/PIV">PIV</a></li><li><a href="/YubiHSM2">YubiHSM2</a></li><li><a href="/Software_Projects">Software Projects</a></li>
</ul>
<!-- Google Custom Search Engine -->
<div class="navbar-form navbar-right" id="search-box">
<script>
          (function() {
            var cx = '017198492754729237489:tcnraf8md8a';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
          })();
          </script>
<gcse:searchbox-only></gcse:searchbox-only>
</div>
<!-- End Google Custom Search Engine -->
</div><!--/.navbar-collapse -->
</div>
</div>
<div class="container">
<div class="row">
<ol class="breadcrumb">
<li><a href="/">Home</a></li>
<li><a href="/yubiauth">yubiauth</a></li>
<li class="active">YubiHSM Setup</li>
</ol>
</div>
<div class="row">
<div class="col-md-4" style="padding-left: 0;">
<!-- Sidebar -->
<ul class="nav nav-side well well-sm">
<li class="active"><a href="/yubiauth">yubiauth</a><ul class="">
<li><a href="/yubiauth/Release_Notes.html">Release Notes</a></li>
<li><a href="/yubiauth/LDAP_Setup.html">LDAP Setup</a></li>
<li><a href="/yubiauth/REST_API.html">REST API</a></li>
<li class="active"><a href="/yubiauth/YubiHSM_Setup.html">YubiHSM Setup</a>
</li></ul>
</li></ul>
<!-- End sidebar -->
</div>
<div class="col-md-8">
<!-- Main content -->
<div class="sidelinks">
<ul>
<li><a href="https://github.com/Yubico/yubiauth" rel="noopener noreferrer" target="_blank"><i class="fa fa-github fa-lg"></i> Github</a></li>
</ul>
</div>
<div id="page-content">
<div class="sect1">
<h1 id="_yubihsm_setup">YubiHSM Setup</h1>
<div class="sectionbody">
<div class="paragraph"><p>While YubiAuth works fine without the use of a
<a href="http://www.yubico.com/products/yubihsm/" rel="noopener noreferrer" target="_blank">YubiHSM</a>, the security of your users
passwords can be greatly increased by use of one. This document describes why
you may want to use a YubiHSM together with YubiAuth, and how to set it all up.</p></div>
<div class="sect2">
<h3 id="_benefits_of_a_yubihsm">Benefits of a YubiHSM</h3>
<div class="sect3">
<h4 id="_without_a_yubihsm">Without a YubiHSM</h4>
<div class="paragraph"><p>In the event that your server becomes compromised, an attacker may gain access
to the YubiAuth database, which stores user credentials such as usernames and
passwords. Passwords are never stored as plain text, they are always hashed
to make it as difficult as possible for an attacker to extract them. Even so,
if the attacker can guess a users password, they can use the database to
verify if their guess is correct or not. Given enough time and processing
power, an attacker test weak passwords such as words or simple phases, and
expose some of your users passwords that way.</p></div>
</div>
<div class="sect3">
<h4 id="_with_a_yubihsm">With a YubiHSM</h4>
<div class="paragraph"><p>When using a YubiHSM, users passwords are hashed using a keyed hash. This key
exists inside the YubiHSM hardware device, and never leaves it. Without the
physical device, it becomes impossible for an attacker to verify if a guessed
password is correct or not. This means that even if an attacker gains access
to the YubiAuth server, the attacker can at most test passwords for as long
as (s)he has access to the machine, and at a very low rate. As soon as the
intrusion becomes detected and the YubiHSM is disconnected (or the attacker
loses access), the attacker can no longer test passwords, even with a copy of
the database.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">Configuration</h3>
<div class="paragraph"><p>For maximum security, a YubiHSM should have as restrictive permissions set as
possible. Here are instructions on how to configure a YubiHSM with the bare
minimum required for use with YubiAuth.</p></div>
<div class="sect3">
<h4 id="_yubihsm">YubiHSM</h4>
<div class="paragraph"><p>Insert the YubiHSM into the USB-slot of a trusted computer, preferably one
which is not connected to the Internet (this is for initially programming the
YubiHSM) while pressing the configuration switch to enter configuration mode.
Once connected, access the device configuration by opening a terminal program,
and connecting to the device (See the
<a href="https://www.yubico.com/wp-content/uploads/2015/04/YubiHSM-Manual_1_5_0.pdf" rel="noopener noreferrer" target="_blank">YubiHSM Manual</a>
for detailed instructions). If the YubiHSM has been previously configured,
begin by erasing the old configuration as described in the manual. With an
empty configuration, program the YubiHSM in hsm mode with HMAC_SHA1_GENERATE
enabled:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>NO CFG&gt; hsm 00010000</pre>
</div></div>
<div class="paragraph"><p>Optionally, set a master password and add admin YubiKeys. See the YubiHSM
manual for more details.</p></div>
<div class="paragraph"><p>Once configured, you will need to generate at least one key to use:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>HSM&gt; keygen 1 1 20 - using flags 00010000 and len 032
00000001,a90327480bdb3876cb84883b91f8795e61fb460f6ba09f2a7fa03554549fe43b
HSM&gt; keycommit - Done</pre>
</div></div>
<div class="paragraph"><p>The above commands will generate a random key and commit it to memory. You
will most likely want to make note of the generated key, but it is vital that
you keep it safe. If it becomes known to an attacker the benefit of having a
YubiHSM will be lost.</p></div>
<div class="paragraph"><p>Once done, exit the configuration mode:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>HSM&gt; exit</pre>
</div></div>
<div class="paragraph"><p>Now, remove the YubiHSM device and plug it into the YubiAuth server machine
(without pressing the configuration mode button). If the YubiHSM was
configured with a master password and/or administrator YubiKeys, you will need
to unlock the device as described in the manual (this needs to be done each
time the server is rebooted).</p></div>
</div>
<div class="sect3">
<h4 id="_python_pyhsm">python-pyhsm</h4>
<div class="paragraph"><p>Once the YubiHSM has been configured with a key that can be used for password
hashing, you need to instruct YubiAuth to use it. First off, you will need to
install the python-pyhsm package if it is not already installed. For debian
this is done by running the following command:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>sudo apt-get install python-pyshm</pre>
</div></div>
<div class="paragraph"><p>The recommended way of interfacing with the YubiHSM through YubiAuth is via
the yhsm-daemon process which is part of the python-pyhsm package. This allows
multiple applications to access a single YubiHSM on the same computer. See the
<a href="https://github.com/Yubico/python-pyhsm/wiki" rel="noopener noreferrer" target="_blank">python-pyhsm documentation</a> for
more information. With the daemon running, YubiAuth can connect to it over the
loopback interface.</p></div>
</div>
<div class="sect3">
<h4 id="_yubiauth">YubiAuth</h4>
<div class="paragraph"><p>Now the only thing remaining is to tell YubiAuth to use the YubiHSM, which is
done by editing the configuration file located here:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>/etc/yubico/auth/yubiauth.conf</pre>
</div></div>
<div class="paragraph"><p>First off, find the USE_HSM setting, and change it to True:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>USE_HSM = True</pre>
</div></div>
<div class="paragraph"><p>Once that is done, the default settings should take care of the rest. You may
want to skim through the rest of the configuration file as well, to make sure
everything is correct. Make sure the YHSM_DEVICE settings is correct according
to how you set up the yhsm-daemon, and make sure CRYPT_CONTEXT has the correct
key handle (the yhsm_pbkdf2_sha1__key_handle setting, which should correspond
to the key generated when running the keygen command in the YubiHSM step).</p></div>
<div class="sect4">
<h5 id="_existing_passwords">Existing passwords</h5>
<div class="paragraph"><p>If this is a new installation you can skip this section. If not, it is
important to realize that existing users passwords are not automatically
protected by the YubiHSM. First, their passwords have to be migrated to use
the YubiHSM, which is automatically done the next time they change their
password. It is up to you to get your existing users to update their
passwords to get the increased security.</p></div>
<div class="paragraph"><p>As an alternative, YubiAuth will automatically migrate users existing passwords
when they log in. This is not quite as secure as having your users change
their passwords, which we recommend you do.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_final_steps">Final steps</h4>
<div class="paragraph"><p>Everything should now be configured correctly. You will need to restart your
web server for the changes to take effect.</p></div>
</div>
</div>
</div>
</div>
</div>
<!-- End main content -->
</div>
</div>
</div>
<footer class="container">
<div class="row" style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;">
<div class="col-md-3">
<p style="line-height:2em;font-size:90%">
<strong><a href="https://developers.yubico.com/" style="color:#000">DEV.YUBICO</a></strong><br>
<a href="/FIDO2">FIDO2</a><br>
<a href="/OTP">OTP</a><br>
<a href="/U2F">U2F</a><br>
<a href="/OATH">OATH</a><br>
<a href="/PGP">PGP</a><br>
<a href="/PIV">PIV</a><br>
<a href="/YubiHSM2">YubiHSM2</a><br>
<a href="/Software_Projects">Software Projects</a><br>
</br></br></br></br></br></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong>RESOURCES</strong><br>
<a href="https://store.yubico.com/" rel="noopener noreferrer" target="_blank">Buy YubiKeys</a><br>
<a href="https://www.yubico.com/blog/" rel="noopener noreferrer" target="_blank">Blog</a><br>
<a href="https://www.yubico.com/newsletter/" rel="noopener noreferrer" target="_blank">Newsletter</a><br>
<a href="http://forum.yubico.com/" rel="noopener noreferrer" target="_blank">Yubico Forum Archive</a></br></br></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:2em;font-size:90%"><strong><a href="https://www.yubico.com/" rel="noopener noreferrer" style="color:#000" target="_blank">YUBICO.COM</a></strong><br>
<a href="https://www.yubico.com/why-yubico/" rel="noopener noreferrer" target="_blank">Why Yubico</a><br>
<a href="https://www.yubico.com/about/about-us/" rel="noopener noreferrer" target="_blank">About Yubico</a></br></br></p>
</div>
<div class="col-md-3">
<p style="line-height:1em;font-size:90%"> </p>
<table align="right" cellpadding="0" cellspacing="0" style="color:#9aca3c">
<tbody>
<tr>
<td style="padding:10px"><a href="https://www.yubico.com/feed/" rel="noopener noreferrer" target="_blank" title="Blog RSS"><i class="fa fa-rss"></i></a></td>
<td style="padding:10px"><a href="https://twitter.com/yubico" rel="noopener noreferrer" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>
<td style="padding:10px"><a href="https://plus.google.com/114531431015898699937" rel="noopener noreferrer" target="_blank" title="Google Plus"><i class="fa fa-google-plus"></i></a></td>
<td style="padding:10px"><a href="https://www.facebook.com/Yubikey" rel="noopener noreferrer" target="_blank" title="Facebook"><i class="fa fa-facebook"></i></a></td>
<td style="padding:10px"><a href="https://www.youtube.com/c/Yubico" rel="noopener noreferrer" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>
<td style="padding:10px 0 10px 10px"><a href="https://github.com/Yubico" rel="noopener noreferrer" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>
</tr>
</tbody>
</table>
</div>
</div>
</footer>
<!-- Offset anchor links for navbar -->
<script>
    var shiftWindow = function() { scrollBy(0, -50) };
    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);
  </script>
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
</body>
</html>