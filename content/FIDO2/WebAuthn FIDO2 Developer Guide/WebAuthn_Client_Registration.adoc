== Web Authentication API
The [W3C Web Authentication API](https://www.w3.org/TR/webauthn/) specification is the authority for implementing WebAuthn. This guide will rely on it’s content for building WebAuthn user authentication experiences. 

WebAuthn specifies an API for creating and using public key credentials. Credentials belong to a user and are managed by an authenticator, which the Relying Party (RP) interacts with through the client. 

== WebAuthn Client Registration
The RP can, with the user’s consent, request the client to create a new credential. In the browser, this is achieved by calling the navigator.credential.create() method. It takes in PublicKeyCredentialsCreationOptions as the argument and returns a PublicKeyCredential. This PublicKeyCredential is then validated by the RP before adding the credential to the user’s account.

<div style="text-align:center">
image::webauthn-registration-flow-01.svg?sanitize=true[]

[W3C WebAuthn Registration Flow Figure](https://www.w3.org/TR/webauthn/images/webauthn-registration-flow-01.svg)
</div>

=== Registration Flow

**0.** The client initiates a request to register an authenticator on behalf of the user. It is a best practice to collect the authenticator nickname. When multiple authenticators are registered, nicknames make them more recognizable to users.

**1.** The RP builds an instance of the PublicKeyCredentialCreationOptions and returns it to the client. It contains information about the user, the Relying Party and desired type of credential.

==== PublicKeyCredentialCreationOptions Example:
[source,javascript]
----
{
  "publicKey": {
    "attestation": "direct",
    "authenticatorSelection": {
      "authenticatorAttachment": "cross-platform",
      "requireResidentKey": false,
      "userVerification": "discouraged"
    },
    "challenge": "qNqrdXUrk5S7dCM1MAYH3qSVDXznb-6prQoGqiACR10=",
    "excludeCredentials": [],
    "pubKeyCredParams": [
      {
        "alg": -7,
        "type": "public-key"
      }
    ],
    "rp": {
      "id": "demo.yubico.com",
      "name": "YubicoDemo"
    },
    "timeout": 30000,
    "user": {
      "displayName": "Yubico demo user",
      "id": "bz9ZDfHzOBLycqISTAdWwWIZt8VO-6mT3hBNXS5jwmY="
    }
  }
}
----

**attestation:** The default value is “none” which means the RP is not interested in authenticator attestation. “indirect” indicates the RP prefers a verifiable attestation statement but allows the client to decide how to obtain it. “direct” indicates the RP wants to receive the attestation statement. It is recommended that RPs use the “direct” value and store the attestation statement with the credential so they can inspect authenticator models retroactively if policy changes.

**authenticatorSelection:** specify authenticator requirements. The optional **authenticatorAttachment** attribute filters eligible authenticator by type. The value “platform” indicates a platform authenticator, like Windows Hello. The value cross-platform value indicates a roaming authenticator, like a security key. When the **requireResidentKey** attribute is true the authenticator must create a client side resident private key. The **userVerification** attribute can be set to a value of “preferred”, “required”, or “discouraged”.

**challenge:** In order to prevent replay attacks, the value should be randomly generated by the RP and encoded in the base64 url safe format.

**excludeCredentials:** limits creation of multiple credentials for same account on a single authenticator. If the authenticator finds an existing credential **type** and **id** for the RP, then a new credential will not be created.

**pubKeyCredParams:** The RP can specify the desired properties of credential to be created. **type:** only one type: “public-key”. **alg:** cryptographic signature algorithm preference specified by [COSE Algorithms registry](https://www.iana.org/assignments/cose/cose.xhtml#algorithms).

**rp:** relying party information. **name** is required. The **id** attribute must be a subdomain of of the origin seen by the client. If id is left out then origins effective domain is used.

**timeout:** the time, in milliseconds, that the caller is willing to wait for the call to complete.

**user:** contains data about the user account. The **displayName** provides a user friendly name which may be displayed to the user. The **id** attribute is the userHandle is generated by the RP and used to uniquely identify a user.

**2.** The JavaScript client calls navigator.credential.create(). The browser validates the rpId against the origin, hashes the clientData, and calls authenticatorMakeCredential method.

**3.** Before proceeding, the authenticator will ask for some form of user verification. After verification, the authenticator will create a new asymmetric key pair and safely store the private key. The public key becomes part of the attestation, which the authenticator signs over with the private key. The manufacturer’s attestation certificate chain may also be returned so that the relying party can validate the device back to a root of trust.

**4.** The new public key, a credential id, and other attestation data are returned to the browser where they become the attestationObject. 

**5.** The navigator.credential.create() Promise resolves to a PublicKeyCredential which returned to the RP to finalize the registration.

==== PublicKeyCredential Example:
[source,javascript]
----
{
  "id": "X9FrwMfmzj...",
  "response": {
    "attestationObject": "o2NmbXRoZmlk...",
    "clientDataJSON": "eyJjaGFsbGVuZ..."
  },
  "clientExtensionResults": {}
}
----

**id:** The credential identifier.

**response:** contains metadata which can be used the RP to asses the characteristics of the credential. The **attestationObject** contains the authenticator data and attestation statement. The **clientDataJSON** contains the JSON-serialized data passed to the authenticator by the client in order to generate the credential.

**clientExtensionResults:** contains values for zero or more WebAuthn extensions.

==== Attestation Object

<div style="text-align:center">
image::webauthn-registration-flow-01.svg?sanitize=true[]

[W3C Attestation Object Illustration](https://www.w3.org/TR/webauthn/images/fido-attestation-structures.svg)
</div>

==== Parsed attestationObject Example
[source,javascript]
----
{
    "attStmt": {
      "alg": -7,
      "sig": "MEUCIQD1...",
      "x5c": [
        "MIICvDCCA..."
      ]
    },
    "authData": {
      "credentialData": {
        "aaguid": "-iuZ3J45QlePkkow0jxBGA==",
        "credentialId": "X9FrwMfmzj...",
        "publicKey": {
          "1": 2,
          "3": -7,
          "-1": 1,
          "-2": "ZsGUIeG53MifPb72qqnmC-X-0PLO-bZiNNow3LUHUYo=",
          "-3": "kuBFf3ZcUc-LAFTPIB8e5DaDt2ofJQ3wAB16zHqNUX0="
        }
      },
      "flags": {
        "AT": true,
        "ED": false,
        "UP": true,
        "UV": false
      },
      "rpIdHash": "xGzvgq0bVGR3WR0Aiwh1nsPm0uy085R0v-ppaZJdA7c=",
      "signatureCounter": 7
    },
    "fmt": "packed"
}
----

**attStmt:** The attestation statement is a signed data object containing statements about the public key credential itself and the authenticator that created it. This example uses the “packed” attestation statement format. The **alg** field contains the [COSE Algorithm identifier](https://www.iana.org/assignments/cose/cose.xhtml#algorithms). The **sig** field contains the attestation signature. The **x5c** contain the attestation certificate and its certificate chain. Use the certificate chain to verify the device is genuine.

**authData:** The authenticator data is a byte array containing data about the make credential operation, including the credential ID and public key.

**credentialData:** the credential data attested by the authenticator.

**aaguid:** An identifier indicating the make and model of the authenticator which is chosen by the manufacturer.

**credentialId:** The credential identifier generated by the authenticator

**publicKey:** The credential public key encoded in [COSE_Key format](https://tools.ietf.org/html/rfc8152). The example is a COSE_Key Elliptic Curve public key in EC2 format. +
  **1:** is the key type. A value of 2 is the EC2 type +
  **3:** is the signature algorithm. A value of -7 is the ES256 signature algorithm +
 **-1:** is the curve type. A value of 1 is the P-256 curve +
 **-2:** is the x-coordinate as byte string +
 **-3:** is the y-coordinate as byte string 

**flags:** The **AT** indicates whether the authenticator added attested credential data. The **ED** flag indicates if the authenticator data has extensions. The **UP** flag indicates if the user is present. The **UV** flag indicates if the user is verified (PIN or biometric).

**rpIdHash:** a SHA-256 has of the RP ID the credential is scoped to.

**signatureCounter:** is incremented for each successful authenticatorGetAssertion operation. It is used by RPs to aid in detecting cloned authenticators. 

**fmt:** The attestation statement format identifier. The format could be one of the defined attestation formats detailed in the W3C WebAuthn spec, e.g.  packed, fido-u2f format, etc...

==== Parsed clientDataJSON Example
[source,javascript]
----
{
  "challenge": "qNqrdXUrk5S7dCM1MAYH3qSVDXznb-6prQoGqiACR10",
  "origin": "https://demo.yubico.com",
  "type": "webauthn.create"
}
----

The **clientDataJSON** object contains the **challenge** sent by the RP, the **origin** of the domain observed by the client, and the **type** of operation performed.

**6.** The RP performs a series of checks to ensure the registration ceremony was not tampered with. Including:

* Verifying the challenge is the same as the challenge that was sent
* Ensuring the origin was the origin expected
* Validating that the signature over the clientDataHash and the attestation using the certificate chain for that specific model of the authenticator. 

The full list of validation steps can be found in the [WebAuthn specification](https://www.w3.org/TR/webauthn/#registering-a-new-credential).

